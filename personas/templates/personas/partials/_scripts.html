<script>
  document.addEventListener('DOMContentLoaded', function () {
    const formPersona = document.getElementById('formPersona');
    const tipoUsuarioSelect = document.getElementById('id_tipo_usuario');
    const departamentoSelect = document.getElementById('id_departamento');
    const cargoSelect = document.getElementById('id_cargo');
    const campoEstado = document.getElementById('campoEstado');
    const campoCargo = document.getElementById('campoCargo');
    const campoDepartamento = document.getElementById('campoDepartamento');
    const persona = document.getElementById('id_persona');
    const urlCrearPersona = "{% url 'crear_persona' %}";
    const urlEditarPersona = "{% url 'editar_persona' %}";

    function setVisible(element, show) {
      element.style.display = show ? 'block' : 'none';
    }

    function toggleCampos() {
      const tipoUsuario = tipoUsuarioSelect.value;
      const tienePersona = Boolean(persona.value);

      if (tipoUsuario === '5') {
        setVisible(campoDepartamento, false);
        setVisible(campoCargo, false);
        setVisible(campoEstado, false);
        return;
      }

      const mostrarDepartamento = ['2', '3', '4'].includes(tipoUsuario); // TIPOS DE USUARIOS
      const mostrarCargo = tipoUsuario === '2';
      const mostrarEstado = mostrarDepartamento && tienePersona;

      setVisible(campoDepartamento, mostrarDepartamento);
      setVisible(campoCargo, mostrarCargo);
      setVisible(campoEstado, mostrarEstado);
    }

    function cargarCargos(deptId) {
      cargoSelect.innerHTML = '<option value="">Cargando...</option>';

      fetch(`/personas/cargos_por_departamento/${deptId}`)
        .then(response => response.json())
        .then(data => {
          cargoSelect.innerHTML = '';

          if (data.cargos.length === 0) {
            cargoSelect.innerHTML = '<option value="">No hay cargos disponibles</option>';
            return;
          }

          cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
          data.cargos.forEach(cargo => {
            const option = document.createElement('option');
            option.value = cargo.id;
            option.textContent = cargo.nombre;

            if (cargo.vacante === 0) {
              option.disabled = true;
              option.style.color = 'gray';
            }
            cargoSelect.appendChild(option);
          });
        });
    }

    function cargarDepartamentos(tipoUsuario) {
      departamentoSelect.innerHTML = '<option value="">Cargando...</option>';

      fetch(`/personas/departamentos_por_tipoUsuario/${tipoUsuario}`)
        .then(response => response.json())
        .then(data => {
          departamentoSelect.innerHTML = '';

          if (data.departamentos.length === 0) {
            departamentoSelect.innerHTML = '<option value="">No hay departamentos disponibles</option>';
            return;
          }

          departamentoSelect.innerHTML = '<option value="">Seleccione un departamento</option>';
          data.departamentos.forEach(departamento => {
            const option = document.createElement('option');
            option.value = departamento.id;
            option.textContent = departamento.nombre;

            departamentoSelect.appendChild(option);
          });
        });
    }

    function limpiarFormulario() {
      formPersona.reset();
      formPersona.action = urlCrearPersona;
      document.getElementById('id_persona').value = '';
      document.getElementById('modalPersonaLabel').textContent = 'Crear Nueva Persona';
      document.querySelector('#formPersona button[type="submit"]').textContent = 'Guardar';
      departamentoSelect.selectedIndex = 0;
      cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
      document.getElementById('campoEstado').style.display = 'none';
      toggleCampos();
    }

    function editarPersona(button) {
      const id = button.getAttribute('data-id');
      const estado = button.getAttribute('data-estado');
      const departamento = button.getAttribute('data-departamento');
      const tipoUsuario = button.getAttribute('data-tipo-usuario');
      const cargo = button.getAttribute('data-cargo');

      formPersona.action = urlEditarPersona;
      document.getElementById('id_persona').value = id;
      document.getElementById('id_nombre').value = button.getAttribute('data-nombre');
      document.getElementById('id_apellido').value = button.getAttribute('data-apellido');
      document.getElementById('id_dni').value = button.getAttribute('data-dni');
      document.getElementById('id_email').value = button.getAttribute('data-email');
      document.getElementById('id_prefijo_pais').value = button.getAttribute('data-prefijo');
      document.getElementById('id_telefono').value = button.getAttribute('data-telefono');
      document.getElementById('id_fecha_nacimiento').value = button.getAttribute('data-fecha-nacimiento');
      document.getElementById('id_genero').value = button.getAttribute('data-genero');
      document.getElementById('id_pais').value = button.getAttribute('data-pais');
      document.getElementById('id_provincia').value = button.getAttribute('data-provincia');
      document.getElementById('id_ciudad').value = button.getAttribute('data-ciudad');
      document.getElementById('id_calle').value = button.getAttribute('data-calle');
      document.getElementById('id_numero').value = button.getAttribute('data-numero');
      tipoUsuarioSelect.value = tipoUsuario;

      toggleCampos();

      if (estado) {
        document.getElementById('id_estado').value = estado;
        document.getElementById('campoEstado').style.display = 'block';
      } else {
        document.getElementById('campoEstado').style.display = 'none';
      }

      if (departamento) {
        departamentoSelect.value = departamento;
        if (['empleado'].includes(tipoUsuario)) {
          cargarCargos(departamento, tipoUsuario, cargo);
        } else {
          cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
        }
      } else {
        departamentoSelect.selectedIndex = 0;
        cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
      }

      document.getElementById('modalPersonaLabel').textContent = 'Editar Persona';
      document.querySelector('#formPersona button[type="submit"]').textContent = 'Actualizar';
    }

    tipoUsuarioSelect.addEventListener('change', function () {
      toggleCampos();
      // Traigo los departamentos correspondientes
      const tipoUsuario = this.value;
      if (['2','3', '4'].includes(tipoUsuario)) {
        cargarDepartamentos(tipoUsuario)
      }
    });

    departamentoSelect.addEventListener('change', function () {
      const deptId = this.value;
      const tipoUsuario = tipoUsuarioSelect.value;
      if (['2'].includes(tipoUsuario)) {
        cargarCargos(deptId);
      }
    });

    document.getElementById('btnCrearPersona').addEventListener('click', limpiarFormulario);

    window.editarPersona = editarPersona;
    toggleCampos();

    document.querySelectorAll('.btn-eliminar').forEach((btn) => {
      btn.addEventListener('click', function () {
        const personaId = this.getAttribute('data-id');
        const personaNombre = this.getAttribute('data-nombre');
        Swal.fire({
          title: '¿Eliminar persona?',
          text: personaNombre ? `Esta acción eliminará a ${personaNombre}.` : 'Esta acción no se puede deshacer.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Sí, eliminar',
          cancelButtonText: 'Cancelar',
        }).then((result) => {
          if (result.isConfirmed) {
            const form = document.getElementById('formEliminarPersona');
            form.action = `/personas/${personaId}/eliminar/`;
            form.submit();
          }
        });
      });
    });

  });

  function setAccion(valor) {
    document.getElementById('accion_input').value = valor;
  }
</script>
