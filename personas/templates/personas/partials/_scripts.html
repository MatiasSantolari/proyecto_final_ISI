<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tipoUsuarioSelect = document.getElementById('id_tipo_usuario');
    const departamentoSelect = document.getElementById('id_departamento');
    const cargoSelect = document.getElementById('id_cargo');

    function toggleCampos() {
      const tipoUsuario = tipoUsuarioSelect.value;
      const campoEstado = document.getElementById('campoEstado');
      const campoCargo = document.getElementById('campoCargo');
      const campoDepartamento = document.getElementById('campoDepartamento');
      const idPersona = document.getElementById('id_persona').value;

      if (tipoUsuario === '5') {
        campoDepartamento.style.display = 'none';
        campoCargo.style.display = 'none';
        campoEstado.style.display = 'none';
        return;
      }
      const mostrar = ['2', '3', '4'].includes(tipoUsuario);

      campoDepartamento.style.display = mostrar ? 'block' : 'none';

      if (['3', '4'].includes(tipoUsuario)) {
        campoCargo.style.display = 'none';
      } else {
        campoCargo.style.display = mostrar ? 'block' : 'none';
      }
      campoEstado.style.display = mostrar && idPersona ? 'block' : 'none';
    }

    function cargarCargos(deptId, tipoUsuario, cargoSeleccionado = null) {
      if (!deptId) {
        cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
        return;
      }
      cargoSelect.innerHTML = '<option value="">Cargando...</option>';

      fetch(`/personas/cargos_por_departamento/${deptId}/?tipo_usuario=${tipoUsuario}`)
        .then(response => response.json())
        .then(data => {
          cargoSelect.innerHTML = '';

          if (data.cargos.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No hay cargos disponibles';
            option.disabled = true;
            cargoSelect.appendChild(option);
            return;
          }

          cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
          data.cargos.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = c.nombre;

            if (c.vacante === 0) {
              option.disabled = true;
              option.style.color = 'gray';
            }
            if (cargoSeleccionado && c.id == cargoSeleccionado) {
              option.selected = true;
            }
            cargoSelect.appendChild(option);
          });
        });
    }

    function limpiarFormulario() {
      const form = document.getElementById('formPersona');
      form.reset();
      document.getElementById('id_persona').value = '';
      document.getElementById('modalPersonaLabel').textContent = 'Crear Nueva Persona';
      document.querySelector('#formPersona button[type="submit"]').textContent = 'Guardar';
      departamentoSelect.selectedIndex = 0;
      cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
      document.getElementById('campoEstado').style.display = 'none';
      toggleCampos();
    }

    function editarPersona(button) {
      const id = button.getAttribute('data-id');
      const estado = button.getAttribute('data-estado');
      const departamento = button.getAttribute('data-departamento');
      const tipoUsuario = button.getAttribute('data-tipo-usuario');
      const cargo = button.getAttribute('data-cargo');

      document.getElementById('id_persona').value = id;
      document.getElementById('id_nombre').value = button.getAttribute('data-nombre');
      document.getElementById('id_apellido').value = button.getAttribute('data-apellido');
      document.getElementById('id_dni').value = button.getAttribute('data-dni');
      document.getElementById('id_email').value = button.getAttribute('data-email');
      document.getElementById('id_prefijo_pais').value = button.getAttribute('data-prefijo');
      document.getElementById('id_telefono').value = button.getAttribute('data-telefono');
      document.getElementById('id_fecha_nacimiento').value = button.getAttribute('data-fecha-nacimiento');
      document.getElementById('id_genero').value = button.getAttribute('data-genero');
      document.getElementById('id_pais').value = button.getAttribute('data-pais');
      document.getElementById('id_provincia').value = button.getAttribute('data-provincia');
      document.getElementById('id_ciudad').value = button.getAttribute('data-ciudad');
      document.getElementById('id_calle').value = button.getAttribute('data-calle');
      document.getElementById('id_numero').value = button.getAttribute('data-numero');
      tipoUsuarioSelect.value = tipoUsuario;

      toggleCampos();

      if (estado) {
        document.getElementById('id_estado').value = estado;
        document.getElementById('campoEstado').style.display = 'block';
      } else {
        document.getElementById('campoEstado').style.display = 'none';
      }

      if (departamento) {
        departamentoSelect.value = departamento;
        if (['empleado'].includes(tipoUsuario)) {
          cargarCargos(departamento, tipoUsuario, cargo);
        } else {
          cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
        }
      } else {
        departamentoSelect.selectedIndex = 0;
        cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
      }

      document.getElementById('modalPersonaLabel').textContent = 'Editar Persona';
      document.querySelector('#formPersona button[type="submit"]').textContent = 'Actualizar';
    }

    tipoUsuarioSelect.addEventListener('change', function () {
      toggleCampos();

      const deptId = departamentoSelect.value;
      const tipoUsuario = this.value;

      if (deptId && ['empleado'].includes(tipoUsuario)) {
        cargarCargos(deptId, tipoUsuario);
      } else {
        cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
      }
    });

    departamentoSelect.addEventListener('change', function () {
      const deptId = this.value;
      const tipoUsuario = tipoUsuarioSelect.value;
      cargarCargos(deptId, tipoUsuario);
    });

    document.getElementById('btnCrearPersona').addEventListener('click', limpiarFormulario);

    window.editarPersona = editarPersona;
    toggleCampos();

    document.querySelectorAll('.btn-eliminar').forEach((btn) => {
      btn.addEventListener('click', function () {
        const personaId = this.getAttribute('data-id');
        const personaNombre = this.getAttribute('data-nombre');
        Swal.fire({
          title: '¿Eliminar persona?',
          text: personaNombre ? `Esta acción eliminará a ${personaNombre}.` : 'Esta acción no se puede deshacer.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Sí, eliminar',
          cancelButtonText: 'Cancelar',
        }).then((result) => {
          if (result.isConfirmed) {
            const form = document.getElementById('formEliminarPersona');
            form.action = `/personas/${personaId}/eliminar/`;
            form.submit();
          }
        });
      });
    });

  });

  function setAccion(valor) {
    document.getElementById('accion_input').value = valor;
  }
</script>
