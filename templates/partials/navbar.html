{% load static %}

<link rel="stylesheet" href="{% static 'css/navbar.css' %}">

<nav class="main-header navbar navbar-expand navbar-main-custom shadow-sm fixed-top px-3 py-2" style="z-index:1100;">
    <div class="collapse navbar-collapse" id="navbarContent">
      <ul class="navbar-nav me-4">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
      </ul>
     <ul class="navbar-nav align-items-center">
        {% if request.session.rol_actual != 'normal' %}
          <li class="nav-item">
              <a class="nav-link fs-5" href="{% url 'home' %}"><i class="bi bi-house-door fs-5 me-2"></i>Inicio </a>
          </li>
        {% else %}
          <li>
            <a class="nav-link fs-5 fw-bold d-flex ml-5" href="{% url 'user_perfil' %}">
              <i class="bi bi-person fs-5 me-2"></i> Perfil
            </a>
          </li>
        {% endif %}
      </ul>
      <ul class="navbar-nav mb-2 mb-lg-0 ms-auto align-items-center">
      {% if request.session.rol_actual != 'normal' %}
        <li class="nav-item me-2">
          <span id="container-btn-entrada-navbar" title="Registrar Entrada de Hoy">
              <button 
                type="button" 
                class="btn btn-success me-2 pt-1 pb-1" 
                data-bs-toggle="modal" 
                data-bs-target="#confirmEntradaModal"
              >
                <i class="bi bi-box-arrow-in-right me-2"></i> Entrada
              </button>
          </span>
        </li>        
        <li class="nav-item">
          <span id="container-btn-salida-navbar" title="Registrar Salida de Hoy">
              <button 
                type="button" 
                class="btn btn-danger me-5 pt-1 pb-1" 
                data-bs-toggle="modal" 
                data-bs-target="#confirmSalidaModal"
              >
                <i class="bi bi-box-arrow-left me-2"></i> Salida
              </button>
          </span>
        </li>
        <li><a class="nav-link" href="{% url 'user_perfil' %}"><i class="bi bi-person me-2"></i> Perfil</a></li>
        <li class="nav-item dropdown ms-3">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-exchange-alt me-1"></i> {{ request.session.rol_actual|title }}
          </a>
          {% if user.rol == "admin" or user.rol == "gerente" or user.rol == "jefe" %}
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                {% if user.rol == 'admin' %}
                  <button type="button" name="rol" data-rol="admin" class="dropdown-item {% if rol_actual == 'admin' %}active{% endif %}" data-bs-toggle="modal" data-bs-target="#confirmarCambioRol">Admin</button>
                  <button type="button" name="rol" data-rol="empleado" class="dropdown-item {% if rol_actual == 'empleado' %}active{% endif %}" data-bs-toggle="modal" data-bs-target="#confirmarCambioRol">Empleado</button>
                  <button type="button" name="rol" data-rol="gerente" class="dropdown-item {% if rol_actual == 'gerente' %}active{% endif %}" data-bs-toggle="modal" data-bs-target="#confirmarCambioRol">Gerente</button>
                  <button type="button" name="rol" data-rol="jefe" class="dropdown-item {% if rol_actual == 'jefe' %}active{% endif %}" data-bs-toggle="modal" data-bs-target="#confirmarCambioRol">Jefe</button>
                {% elif user.rol == 'gerente' %}
                  <button type="button" name="rol" data-rol="gerente" class="dropdown-item {% if rol_actual == 'gerente' %}active{% endif %}" data-bs-toggle="modal" data-bs-target="#confirmarCambioRol">Gerente</button>
                  <button type="button" name="rol" data-rol="empleado" class="dropdown-item {% if rol_actual == 'empleado' %}active{% endif %}" data-bs-toggle="modal" data-bs-target="#confirmarCambioRol">Empleado</button>
                {% elif user.rol == 'jefe' %}
                  <button type="button" name="rol" data-rol="jefe" class="dropdown-item {% if rol_actual == 'jefe' %}active{% endif %}" data-bs-toggle="modal" data-bs-target="#confirmarCambioRol">Jefe</button>
                  <button type="button" name="rol" data-rol="empleado" class="dropdown-item {% if rol_actual == 'empleado' %}active{% endif %}" data-bs-toggle="modal" data-bs-target="#confirmarCambioRol">Empleado</button>
                {% endif %}
              </li>
            </ul>
          {% endif %}
        </li>
      {% endif %}  

        <li>
          <button id="theme-toggle" class="btn nav-item">
            <span id="theme-icon">ðŸŒ™</span> 
          </button>
        </li>
       <!--
         <li class="nav-item dropdown">
          <a class="nav-link position-relative" href="#" data-bs-toggle="dropdown">
            <i class="far fa-bell"></i>
            <span class="position-absolute top-1 start-99 translate-middle badge rounded-pill bg-warning">3</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><h6 class="dropdown-header">Notificaciones</h6></li>
            <li><a class="dropdown-item" href="#">Nueva solicitud recibida</a></li>
            <li><a class="dropdown-item" href="#">ActualizaciÃ³n de perfil</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#">Ver todas</a></li>
          </ul>
        </li>
        -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
            <i class="fas fa-user-circle me-0"></i> {{ request.user.nombre_usuario }}
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
          <!--
            <li><a class="dropdown-item" href="#"><i class="bi bi-gear"></i> ConfiguraciÃ³n</a></li>
            
            <li><hr class="dropdown-divider"></li>
          -->
            <li>
              <form action="{% url 'logout' %}" method="post" style="display: block; margin: 0;">
                {% csrf_token %}
                <button type="submit" class="dropdown-item text-danger" style="background: none; border: none; width: 100%; text-align: left; padding-left: 1rem;">
                  <i class="bi bi-box-arrow-right me-2"></i> Cerrar sesiÃ³n
                </button>
              </form>
            </li>
          </ul>
        </li>
      </ul>
    </div>
    <div class="modal fade" id="confirmEntradaModal" tabindex="-1" aria-labelledby="confirmEntradaLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h5 class="modal-title" id="confirmEntradaLabel">Confirmar Entrada</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center">
              Â¿EstÃ¡s seguro que quieres registrar tu <strong>entrada</strong> para hoy <strong>{{ hoy|date:"d/m/Y" }}</strong>?
            </div>
            <div class="modal-footer justify-content-center">
              <button type="button" class="btn-sm btn-secondary me-4" data-bs-dismiss="modal">Cancelar</button>
              <form method="post" action="{% url 'registrar_asistencia' %}">
                {% csrf_token %}
                <button type="submit" name="accion" value="entrada" class="btn btn-success">SÃ­, registrar</button>
              </form>
            </div>
          </div>
        </div>
    </div>
    <div class="modal fade" id="confirmSalidaModal" tabindex="-1" aria-labelledby="confirmSalidaLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="confirmSalidaLabel">Confirmar Salida</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body text-center">
            Â¿EstÃ¡s seguro que quieres registrar tu <strong>salida</strong> para hoy <strong>{{ hoy|date:"d/m/Y" }}</strong>?
          </div>
          <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <form method="post" action="{% url 'registrar_asistencia' %}">
              {% csrf_token %}
              <button type="submit" name="accion" value="salida" class="btn btn-danger">SÃ­, registrar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="confirmarCambioRol" tabindex="-1" aria-labelledby="confirmarCambioRolLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title" id="confirmarCambioRolLabel">Confirmar cambio de rol</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            Â¿Seguro que deseas cambiar al rol de "<span id="rolSeleccionadoTexto"></span>"? SerÃ¡s redirigido al inicio y podrÃ­as perder los cambios no guardados.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <form id="formCambiarRol" action="{% url 'cambiar_vista' %}" method="post">
              {% csrf_token %}
              <input type="hidden" name="rol" id="inputRolSeleccionado">
              <button type="submit" class="btn btn-warning">SÃ­, cambiar</button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const rolInput = document.getElementById("inputRolSeleccionado");
        const rolTexto = document.getElementById("rolSeleccionadoTexto");
        const modalElement = document.getElementById('confirmarCambioRol');
        const modal = new bootstrap.Modal(modalElement);

        document.querySelectorAll('.dropdown-toggle').forEach(dropdown => {
          new bootstrap.Dropdown(dropdown);
        });
    
        document.querySelectorAll("[data-rol]").forEach(item => {
          item.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            const rol = item.dataset.rol;
            rolInput.value = rol;      
            rolTexto.textContent = rol; 
            modal.show();
          });
        });    
      });


      document.addEventListener("DOMContentLoaded", function () {
        const toggleBtn = document.getElementById("theme-toggle");
        const themeIcon = document.getElementById("theme-icon");
        const savedTheme = localStorage.getItem("theme");

        function applyTheme(theme) {
            if (theme === "dark") {
                document.body.classList.add("dark-mode");
                themeIcon.textContent = "â˜€ï¸"; 
            } else {
                document.body.classList.remove("dark-mode");
                themeIcon.textContent = "ðŸŒ™"; 
            }
        }
        
        if (savedTheme) {
        applyTheme(savedTheme);
        } else {
            applyTheme("light"); 
        }

        toggleBtn.addEventListener("click", function () {
            const isDarkMode = document.body.classList.contains("dark-mode");
            
            const newTheme = isDarkMode ? "light" : "dark";

            applyTheme(newTheme);
            localStorage.setItem("theme", newTheme);
        });
    });


    document.addEventListener('DOMContentLoaded', (event) => {
        const asistenciaHoyRegistrada = "{{ asistencia_hoy.pk }}" && "{{ asistencia_hoy.pk }}" !== 'None';
        const horaSalidaRegistrada = "{{ asistencia_hoy.hora_salida }}" && "{{ asistencia_hoy.hora_salida }}" !== 'None';

        const containerEntrada = document.getElementById('container-btn-entrada-navbar');
        const containerSalida = document.getElementById('container-btn-salida-navbar');
        
        const btnEntrada = containerEntrada ? containerEntrada.querySelector('button') : null;
        const btnSalida = containerSalida ? containerSalida.querySelector('button') : null;

        if (btnEntrada && btnSalida && containerEntrada && containerSalida) {
            if (asistenciaHoyRegistrada) {
                btnEntrada.classList.remove('btn-primary');
                btnEntrada.classList.add('btn-success');
                btnEntrada.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> Entrada OK';
                btnEntrada.disabled = true;
                containerEntrada.title = "Â¡Ya registraste tu entrada de hoy!"; 

                if (horaSalidaRegistrada) {
                    btnSalida.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> Salida OK';
                    btnSalida.disabled = true;
                    containerSalida.title = "Â¡Ya registraste tu salida de hoy!";
                }
            } else {
                btnSalida.disabled = true;
                btnSalida.classList.remove('btn-danger');
                btnSalida.classList.add('btn-secondary');
                containerSalida.title = "Debes registrar la entrada primero.";
            }
        }
    });
  </script>

</nav>
