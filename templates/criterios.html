{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Gestión de Criterios{% endblock %}

{% block content %}
<div class="container my-5">
  <h2 class="mb-4" style="color: var(--color-primario);">Gestión de Criterios</h2>

  <button type="button" class="btn mb-3 btn-primary" data-bs-toggle="modal" data-bs-target="#modalCriterio">
    + Crear Nuevo Criterio
  </button>

  <div class="card shadow-sm border-0">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-hover table-bordered align-middle mb-0" style="min-width: 1000px; font-size: 0.9rem;">
          <thead class="table-light text-center">
            <tr>
              <th>Descripción</th>
              <th>Tipo de Criterio</th>
              <th style="width:12%;">Acciones</th>
            </tr>
          </thead>
          <tbody class="text-center">
            {% for c in criterios %}
            <tr>
              <td>{{ c.descripcion }}</td>
              <td>{{ c.tipo_criterio.descripcion }}</td>
              <td>
                <div class="d-flex justify-content-center gap-2">
                  <button class="btn btn-sm btn-outline-secondary"
                          data-bs-toggle="modal" data-bs-target="#modalCriterio"
                          data-id="{{ c.id }}"
                          data-descripcion="{{ c.descripcion }}"
                          data-tipo="{{ c.tipo_criterio.id }}"
                          onclick="editarCriterio(this)">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-info"
                          data-bs-toggle="modal"
                          data-bs-target="#modalVerCriterio{{ c.id }}">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger"
                          data-bs-toggle="modal"
                          data-bs-target="#modalEliminarCriterio"
                          data-id="{{ c.id }}">
                    <i class="bi bi-trash3"></i>
                  </button>
                </div>
              </td>
            </tr>

            <!-- Modal Ver -->
            <div class="modal fade" id="modalVerCriterio{{ c.id }}" tabindex="-1">
              <div class="modal-dialog" style="margin-top: 6rem;">
                <div class="modal-content">
                  <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Detalles del Criterio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <p><strong>Tipo:</strong> {{ c.tipo_criterio.descripcion }}</p>
                    <p><strong>Descripción:</strong> {{ c.descripcion }}</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal Eliminar -->
            <div class="modal fade" id="modalEliminarCriterio" tabindex="-1">
              <div class="modal-dialog" style="margin-top: 12rem;">
                <div class="modal-content">
                  <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <p>¿Estás seguro de eliminar el Criterio: <strong>({{ c.descripcion }})</strong>, perteneciente al Tipo: <strong>({{ c.tipo_criterio.descripcion }})</strong>?</p>
                  </div>
                  <div class="modal-footer">
                    <form id="formEliminarCriterio" method="post">
                      {% csrf_token %}
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      <button type="submit" class="btn btn-danger">Eliminar</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
  
          {% empty %}
            <tr>
              <td colspan="3" class="text-center text-muted">No hay criterios registrados.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <nav aria-label="Paginación">
          <ul class="pagination justify-content-center mt-4">
            {% if criterios.has_previous %}
              <li class="page-item"><a class="page-link" href="?page={{ criterios.previous_page_number }}">&laquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}

            {% for num in criterios.paginator.page_range %}
              {% if criterios.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
              {% endif %}
            {% endfor %}

            {% if criterios.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ criterios.next_page_number }}">&raquo;</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Modal Crear/Editar -->
  <div class="modal fade" id="modalCriterio" tabindex="-1">
    <div class="modal-dialog" style="margin-top: 6rem;">
      <div class="modal-content">
        <form method="post" action="{% url 'crear_criterio' %}" id="formCriterio">
          {% csrf_token %}
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalCriterioLabel">Crear/Editar Criterio</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <input type="hidden" name="id_criterio" id="id_criterio">
          <div class="modal-body">
            
            <div class="mb-3">
              <label class="form-label">Tipo de Criterio</label>
              {{ form.tipo_criterio }}
            </div>

            <div id="contenedor-descripciones">
              <div class="mb-3 descripcion-item">
                <label class="form-label">Descripción</label>
                <input type="text" name="descripciones[]" class="form-control" placeholder="Ingrese descripción">
              </div>
            </div>

            <div id="botonAgregarWrapper">
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="agregarDescripcion()">
                <i class="bi bi-plus-circle"></i> Crear otro Criterio
              </button>
            </div>

          </div>
          <div class="modal-footer bg-light">
            <button type="submit" class="btn btn-success w-100 fw-bold">
              <i class="bi bi-save"></i> Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>
  

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modalEliminar = document.getElementById('modalEliminarCriterio');
    if (modalEliminar) {
      modalEliminar.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const criterioId = button.getAttribute('data-id');
        const form = document.getElementById('formEliminarCriterio');
        form.action = `/criterios/${criterioId}/eliminar/`;
      });
    }
  });

  function editarCriterio(button) {
    const id = button.getAttribute('data-id');
    const descripcion = button.getAttribute('data-descripcion');
    const tipo = button.getAttribute('data-tipo');

    document.getElementById('id_criterio').value = id;
    document.getElementById('id_descripcion').value = descripcion;
    document.getElementById('id_tipo_criterio').value = tipo;

    document.getElementById('modalCriterioLabel').textContent = 'Editar Criterio';
    document.querySelector('#formCriterio button[type="submit"]').textContent = 'Actualizar';
  }


  document.addEventListener("DOMContentLoaded", function () {
    const contenedor = document.getElementById("contenedor-descripciones");
    const botonAgregarWrapper = document.getElementById("botonAgregarWrapper");

    const modalCriterio = document.getElementById("modalCriterio");
    modalCriterio.addEventListener("show.bs.modal", function (event) {
      const trigger = event.relatedTarget;
      const esCreacion = !trigger.getAttribute("data-id");

      if (esCreacion) {
        document.getElementById("id_criterio").value = "";
        document.getElementById("modalCriterioLabel").textContent = "Crear Nuevo Criterio";
        document.querySelector("#formCriterio button[type='submit']").textContent = "Guardar";

        contenedor.innerHTML = `
          <div class="mb-3 descripcion-item">
            <label class="form-label">Descripción</label>
            <input type="text" name="descripciones[]" class="form-control" placeholder="Ingrese descripción">
          </div>
        `;

        document.getElementById("id_tipo_criterio").selectedIndex = 0;
        botonAgregarWrapper.style.display = "block";

      } else {
        const id = trigger.getAttribute("data-id");
        const descripcion = trigger.getAttribute("data-descripcion");
        const tipo = trigger.getAttribute("data-tipo");

        document.getElementById("id_criterio").value = id;
        document.getElementById("modalCriterioLabel").textContent = "Editar Criterio";
        document.querySelector("#formCriterio button[type='submit']").textContent = "Actualizar";

        contenedor.innerHTML = `
          <div class="mb-3 descripcion-item">
            <label class="form-label">Descripción</label>
            <input type="text" name="descripciones[]" class="form-control" value="${descripcion}">
          </div>
        `;

        document.getElementById("id_tipo_criterio").value = tipo;

        botonAgregarWrapper.style.display = "none";
      }
    });
  });

  function agregarDescripcion() {
    const contenedor = document.getElementById("contenedor-descripciones");
    const nuevo = document.createElement("div");
    nuevo.classList.add("mb-3", "descripcion-item");
    nuevo.innerHTML = `
      <input type="text" name="descripciones[]" class="form-control" placeholder="Ingrese descripción">
    `;
    contenedor.appendChild(nuevo);
  }


</script>
{% endblock %}
