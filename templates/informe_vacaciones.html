{% extends "base.html" %}
{% block title %}Informe Vacaciones{% endblock %}

{% block content %}
<div class="container my-5">
  <h4 class="mb-4" style="color: var(--color-primario);">Informe Completo de Vacaciones</h4>

  <div class="row mb-4 g-2 align-items-end">
    <div class="col-md-3">
      <label class="form-label small">Departamento</label>
      <select id="departamentoFiltro" class="form-select form-select-sm">
        <option value="">Todos los departamentos</option>
        {% for dep in departamentos %}
        <option value="{{ dep.id }}">{{ dep.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label small">Periodo</label>
      <select id="periodoFiltro" class="form-select form-select-sm">
        <option value="semana">Última Semana</option>
        <option value="mes">Último Mes</option>
        <option value="año">Último Año</option>
      </select>
    </div>
  </div>

  <div class="d-flex justify-content-between text-center gap-2 mb-3 mt-3">
    <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
      <div class="text-muted small">Empleados</div>
      <strong id="totalEmpleados" class="text-primary fs-5">0</strong>
    </div>
    <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
      <div class="text-muted small">Solicitudes</div>
      <strong id="totalSolicitudes" class="text-info fs-5">0</strong>
    </div>
    <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
      <div class="text-muted small">Aprobadas</div>
      <strong id="aprobadas" class="text-success fs-5">0</strong>
    </div>
    <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
      <div class="text-muted small">Pendientes</div>
      <strong id="pendientes" class="text-warning fs-5">0</strong>
    </div>
    <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
      <div class="text-muted small">Rechazadas</div>
      <strong id="rechazadas" class="text-danger fs-5">0</strong>
    </div>
  </div>

  <div class="row mb-4 mt-4">
    <div class="col-md-5">
      <canvas id="graficoVacaciones" style="width:100%; min-height:275px;"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="graficoDepartamento" style="width:100%; min-height:275px;"></canvas>
    </div>
  </div>

  <div class="card shadow-sm border-0 mt-3">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-hover table-bordered align-middle mb-0">
          <thead class="table-light text-center">
            <tr>
              <th>Empleado</th>
              <th>Departamento</th>
              <th>Fecha Solicitud</th>
              <th>Fecha Inicio</th>
              <th>Fecha Fin</th>
              <th>Días</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="tablaCuerpo" class="text-center"></tbody>
        </table>

        <nav aria-label="Paginación">
            <ul id="paginacion" class="pagination justify-content-center mt-4"></ul>
        </nav>

      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const ctx1 = document.getElementById('graficoVacaciones').getContext('2d');
    const ctx2 = document.getElementById('graficoDepartamento').getContext('2d');
    let graficoGeneral, graficoDepto;
    let paginaActual = 1;

    async function cargarDatos(pagina=1){
        paginaActual = pagina;
        const dep = document.getElementById('departamentoFiltro').value;
        const periodo = document.getElementById('periodoFiltro').value;

        const resp = await fetch(`{% url 'informe_vacaciones_data' %}?departamento=${dep}&periodo=${periodo}&page=${pagina}`);
        const data = await resp.json();

        document.getElementById('totalEmpleados').textContent = data.total_empleados;
        document.getElementById('totalSolicitudes').textContent = data.total_solicitudes;
        document.getElementById('aprobadas').textContent = data.aprobadas;
        document.getElementById('pendientes').textContent = data.pendientes;
        document.getElementById('rechazadas').textContent = data.rechazadas;

        const tbody = document.getElementById('tablaCuerpo');
        tbody.innerHTML = '';
        if(data.detalle.length === 0){
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No hay registros</td></tr>`;
        } else {
            data.detalle.forEach(s => {
                tbody.innerHTML += `
                <tr>
                    <td>${s.empleado}</td>
                    <td>${s.departamento}</td>
                    <td>${s.fecha_solicitud}</td>
                    <td>${s.fecha_inicio}</td>
                    <td>${s.fecha_fin}</td>
                    <td>${s.dias}</td>
                    <td>${s.estado}</td>
                </tr>`;
            });
        }

        if(graficoGeneral) graficoGeneral.destroy();
        if (data.aprobadas + data.pendientes + data.rechazadas === 0) {
            ctx1.clearRect(0, 0, ctx1.canvas.width, ctx1.canvas.height);
            ctx1.font = "14px Arial";
            ctx1.fillStyle = "#000000"; // o "#ffffff" si fondo oscuro
            ctx1.textAlign = "center";
            ctx1.textBaseline = "middle";
            ctx1.fillText("No hay datos para este periodo", ctx1.canvas.width / 2, ctx1.canvas.height / 2);
        } else {
            graficoGeneral = new Chart(ctx1, {
                type:'doughnut',
                data:{
                    labels:['Aprobadas','Pendientes','Rechazadas'],
                    datasets:[{
                        data:[data.aprobadas,data.pendientes,data.rechazadas],
                        backgroundColor:['#198754','#ffc107','#dc3545'],
                        hoverOffset:10
                    }]
                },
                options:{responsive:true}
            });
        }

        
        if(graficoDepto) graficoDepto.destroy();
        if(data.departamentos_labels.length === 0){
            ctx2.clearRect(0, 0, ctx2.canvas.width, ctx2.canvas.height);
        } else {
            graficoDepto = new Chart(ctx2, {
                type:'bar',
                data:{
                    labels:data.departamentos_labels,
                    datasets:[
                        {label:'Aprobadas', data:data.departamentos_aprobadas, backgroundColor:'#198754'},
                        {label:'Pendientes', data:data.departamentos_pendientes, backgroundColor:'#ffc107'},
                        {label:'Rechazadas', data:data.departamentos_rechazadas, backgroundColor:'#dc3545'}
                    ]
                },
                options:{
                    responsive:true,
                    scales:{
                        y:{beginAtZero:true, ticks:{stepSize:1, precision:0}}
                    }
                }
            });
        }

        // Paginación
        const pagNav = document.getElementById('paginacion');
        let html = '';
        if(data.paginator.has_previous){
            html += `<li class="page-item"><a class="page-link" href="#" onclick="cargarDatos(${data.paginator.previous_page_number});return false;">&laquo;</a></li>`;
        } else html += `<li class="page-item disabled"><span class="page-link">&laquo;</span></li>`;

        for(let i=1;i<=data.paginator.num_pages;i++){
            if(i===data.paginator.current_page) html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
            else html += `<li class="page-item"><a class="page-link" href="#" onclick="cargarDatos(${i});return false;">${i}</a></li>`;
        }

        if(data.paginator.has_next){
            html += `<li class="page-item"><a class="page-link" href="#" onclick="cargarDatos(${data.paginator.next_page_number});return false;">&raquo;</a></li>`;
        } else html += `<li class="page-item disabled"><span class="page-link">&raquo;</span></li>`;
        pagNav.innerHTML = html;
    }

    document.getElementById('departamentoFiltro').addEventListener('change', ()=>cargarDatos(1));
    document.getElementById('periodoFiltro').addEventListener('change', ()=>cargarDatos(1));

    cargarDatos();
});
</script>

{% endblock %}