<div class="card bg-gradient-info shadow-sm mb-3 dashboard-mini" style="max-width: 450px;">
  <div class="card-header border-0 d-flex justify-content-between align-items-center">
    <h6 class="card-title">
      <i class="fas fa-chart-pie mr-1"></i> Resumen Asistencias
    </h6>
  </div>

  <div class="card-body p-1">
    <!-- Filtros compactos -->
    <div class="d-flex gap-1 mb-1">
      <select id="departamentoFiltro" class="form-select form-select-sm flex-fill">
        <option value="">Todos</option>
        {% for dep in departamentos %}
        <option value="{{ dep.id }}">{{ dep.nombre }}</option>
        {% endfor %}
      </select>
      <select id="periodoFiltro" class="form-select form-select-sm flex-fill">
        <option value="hoy">Hoy</option>
        <option value="semana">Última Semana</option>
        <option value="mes">Último Mes</option>
        <option value="año">Último Año</option>
      </select>
    </div>

    <div class="d-flex justify-content-between text-center gap-2 mb-3 mt-3">
      <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
        <div class="text-muted small">Empleados</div>
        <strong id="totalEmpleados" class="text-primary fs-5">0</strong>
      </div>
      <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
        <div class="text-muted small">Registros</div>
        <strong id="totalRegistros" class="text-info fs-5">0</strong>
      </div>
      <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
        <div class="text-muted small">Asistencias</div>
        <strong id="asistenciasConfirmadas" class="text-success fs-5">0</strong>
      </div>
      <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
        <div class="text-muted small">Tardanzas</div>
        <strong id="tardanzas" class="text-warning fs-5">0</strong>
      </div>
      <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
        <div class="text-muted small">Ausencias</div>
        <strong id="ausencias" class="text-danger fs-5">0</strong>
      </div>
    </div>

    <!-- Gráfico pequeño -->
    <canvas id="graficoDashboard" class="mt-4" style="max-height: 350px; width: 100%;"></canvas>

    <div class="mt-2 text-end">
      <a href="{% url 'informe_asistencias' %}" class="btn btn-warning btn-sm">Ver +</a>
    </div>
  </div>
</div>



<style>
  .dashboard-mini {
    transform: scale(0.9);
    transform-origin: top left;
  }

  .dashboard-mini {
    margin-top: -10px;
  }

  .dashboard-mini * {
    font-size: 1em;
  }
</style>


<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const ctx = document.getElementById('graficoDashboard').getContext('2d');
  let grafico;

  async function cargarDashboard() {
    try {
      const dep = document.getElementById('departamentoFiltro').value;
      const periodo = document.getElementById('periodoFiltro').value;

      const resp = await fetch(`{% url 'dashboard_asistencias_data' %}?departamento=${dep}&periodo=${periodo}`);
      const data = await resp.json();

      document.getElementById('totalEmpleados').textContent = data.total_empleados;
      document.getElementById('totalRegistros').textContent = data.total_registros;
      document.getElementById('asistenciasConfirmadas').textContent = data.asistencias;
      document.getElementById('tardanzas').textContent = data.tardanzas;
      document.getElementById('ausencias').textContent = data.ausencias;

      if(grafico) grafico.destroy();
      grafico = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Asistencias', 'Tardanzas', 'Ausencias'],
          datasets: [{
            data: [data.asistencias, data.tardanzas, data.ausencias],
            backgroundColor: ['#198754','#ffc107','#dc3545'],
            hoverOffset: 10
          }]
        },
        options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom', 
                        labels: {
                            color: '#ffffff',
                            font: { size: 14 },
                            boxWidth: 10,      
                            boxHeight: 10,     
                            padding: 20,
                        },
                        align: 'center',        
                        maxWidth: 300,          
                        display: true
                    },
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.raw;
                            }
                        }
                    }
                },
                animation: { animateRotate:true, animateScale:true }
            }
        });

    } catch (err) {
      console.error("Error cargando dashboard:", err);
    }
  }

  document.getElementById('departamentoFiltro').addEventListener('change', cargarDashboard);
  document.getElementById('periodoFiltro').addEventListener('change', cargarDashboard);

  cargarDashboard();

});
</script>
