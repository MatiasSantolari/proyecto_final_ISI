{% extends "base.html"%}
{% load widget_tweaks %}

  {% block title %}Gestión de Objetivos{% endblock %}
  
  {% block content %}

  <div class="container my-5">
    <h1 class="mb-4" style="color: var(--color-primario);">Gestión de Objetivos</h1>

    <!-- Botón para Crear -->
    <button type="button" class="btn mb-3 btn-primary" data-bs-toggle="modal" data-bs-target="#modalObjetivo">
      + Crear Nuevo Objetivo
    </button>

    <!-- Tabla de Objetivos -->
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover table-bordered align-middle mb-0">
            <thead style="table-light text-center">
              <tr>
                <th style="width: 50%;">Titulo</th>
                <th style="width: 10%;">Fecha Creacion</th>
                <th style="width: 10%;">Fecha Fin</th>
                <th style="width: 10%;">Estado</th>
                <th style="width: 10%;">Activo</th>
                <th style="width: 10%;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for objetivo in objetivos %}
              <tr>
                <td>{{ objetivo.titulo }}</td>
                <td>
                  {% if objetivo.fecha_creacion %}
                    {{ objetivo.fecha_creacion|date:"d/m/Y" }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if objetivo.fecha_fin %}
                    {{ objetivo.fecha_fin|date:"d/m/Y" }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {{ objetivo.estado_asignacion }}
                </td>
                <td class="text-center">
                  {% if objetivo.activo %}
                    <span class="badge bg-success">Sí</span>
                  {% else %}
                    <span class="badge bg-danger">No</span>
                  {% endif %}
                </td>
                <td>
                  <div class="d-flex justify-content-center gap-2">
                     <button class="btn btn-sm btn-outline-primary"
                            data-bs-toggle="modal" 
                            data-bs-target="#modalAsignarObjetivo"
                            data-objetivo-id="{{ objetivo.id }}"
                            data-objetivo-titulo="{{ objetivo.titulo }}"
                            data-bs-toggle="tooltip" title="Asignar"
                            onclick="abrirModalAsignar({{ objetivo.id }})">
                      <i class="bi bi-person-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" 
                            data-bs-toggle="modal" data-bs-target="#modalObjetivo"
                            data-id="{{ objetivo.id }}"
                            data-titulo="{{ objetivo.titulo }}"
                            data-fechaFin="{{ objetivo.fecha_fin|date:'Y-m-d' }}"
                            data-descripcion="{{ objetivo.descripcion }}"
                            data-esrecurrente="{{ objetivo.es_recurrente }}"
                            data-estado="{{ objetivo.estado }}"
                            onclick="editarObjetivo(this)"
                            data-bs-toggle="tooltip" title="Editar">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" 
                            data-bs-toggle="modal" 
                            data-bs-target="#modalVerObjetivo{{ objetivo.id }}"
                            data-bs-toggle="tooltip" title="Ver">
                      <i class="bi bi-eye"></i>
                    </button>
                    {% if objetivo.activo %}
                      <button class="btn btn-sm btn-outline-danger" 
                              data-bs-toggle="modal" 
                              data-bs-target="#modalDesactivarObjetivo"
                              data-id="{{ objetivo.id }}"
                              data-bs-toggle="tooltip" title="Desactivar">
                        <i class="bi bi-trash3"></i>
                      </button>
                    {% else %}
                      <button class="btn btn-sm btn-outline-success" 
                              data-bs-toggle="modal" 
                              data-bs-target="#modalActivarObjetivo"
                              data-id="{{ objetivo.id }}"
                              data-bs-toggle="tooltip" title="Activar">
                        <i class="bi bi-arrow-clockwise"></i>
                      </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted">
                  No hay objetivos registrados.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>


    <!-- Modal para Crear/Editar Objetivo -->
    <div class="modal fade" id="modalObjetivo" tabindex="-1" aria-labelledby="modalObjetivoLabel" aria-hidden="true">
      <div class="modal-dialog" style="margin-top: 6rem;">
        <div class="modal-content">
          <form method="post" action="{% url 'crear_objetivo' %}" id="formObjetivo">
            {% csrf_token %}
            <div class="modal-header" style="background-color: #3c8dbc;">
              <h5 class="modal-title text-white" id="modalObjetivoLabel">Crear/Editar Objetivo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <input type="hidden" name="id_objetivo" id="id_objetivo">
            <div class="modal-body">
              <div class="mb-3">
                <label for="id_titulo" class="form-label">Titulo del Objetivo</label>
                {{ form.titulo }}
              </div>
              <div class="mb-3">
                <label for="id_descripcion" class="form-label">Descripcion del Objetivo</label>
                {{ form.descripcion }}
              </div>
              <div class="mb-3 form-check">
                {{ form.es_recurrente }}
                <label for="id_es_recurrente" class="form-check-label">¿Es recurrente?</label>
              </div>
              <div class="mb-3">
                <label for="id_fechaFin" class="form-label">Fecha de Fin</label>
                {{ form.fecha_fin }}
              </div>
              
              
              <div class="modal-footer bg-light">
                <button type="submit" class="btn btn-success w-50 fw-bold" name="accion" value="guardar">
                  <i class="bi bi-save"></i> Guardar
                </button>
                <button type="submit" class="btn btn-primary w-50 fw-bold" name="accion" value="guardar_y_asignar">
                  <i class="bi bi-check2-circle"></i> Guardar y Asignar
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Modal Asignar Objetivo -->
    <div class="modal fade" id="modalAsignarObjetivo" tabindex="-1" aria-labelledby="modalAsignarObjetivoLabel" aria-hidden="true">
      <div class="modal-dialog" style="margin-top: 6rem;">
        <div class="modal-content">
          <form method="post" action="{% url 'asignar_objetivo' %}">
            {% csrf_token %}
            <input type="hidden" name="objetivo_id" id="asignarObjetivoId">

            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="modalAsignarObjetivoLabel">Asignar Objetivo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <div class="mb-3">
                <label for="tipoAsignacion" class="form-label">Asignar a:</label>
                <select id="tipoAsignacion" name="tipo_asignacion" class="form-select" onchange="mostrarSelectorAsignacion(this.value)" required>
                  <option value="">Seleccione una opción</option>
                  <option value="empleado">Empleado</option>
                  <option value="cargo">Cargo</option>
                </select>
              </div>

              <div class="mb-3 d-none" id="selectorEmpleado">
                <label class="form-label">Seleccione Empleado</label>
                <div>
                  {% for empleado in empleados %}
                    {% with empleado.empleadocargo_set.last as cargo_actual %}
                      <div class="form-check">
                        <input 
                          class="form-check-input" 
                          type="checkbox" 
                          name="empleado_id" 
                          value="{{ empleado.id }}" 
                          id="empleado{{ empleado.id }}"
                        >
                        <label class="form-check-label" for="empleado{{ empleado.id }}">
                          {{ empleado.nombre }} {{ empleado.apellido }}
                          {% if cargo_actual %} - {{ cargo_actual.cargo.nombre }}{% endif %}
                        </label>
                      </div>
                    {% endwith %}
                  {% endfor %}
                </div>
              </div>

              <div class="mb-3 d-none" id="selectorCargo">
                <label for="cargoSelect" class="form-label">Seleccione Cargo</label>
                <select name="cargo_id" id="cargoSelect" class="form-select" required>
                  {% for cargo in cargos %}
                    <option value="{{ cargo.id }}">{{ cargo.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="modal-footer bg-light">
              <button type="submit" class="btn btn-primary w-100 fw-bold">
                <i class="bi bi-send"></i> Asignar
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>


    <!-- Modal para Ver Detalles -->
    {% for objetivo in objetivos %}
    <div class="modal fade" id="modalVerObjetivo{{ objetivo.id }}" tabindex="-1" aria-labelledby="modalVerObjetivoLabel{{ objetivo.id }}" aria-hidden="true">
      <div class="modal-dialog" style="margin-top: 6rem;">
        <div class="modal-content">
          <div class="modal-header" style="background-color: #3c8dbc;">
            <h5 class="modal-title text-white" id="modalVerObjetivoLabel{{ objetivo.id }}">Detalles del Objetivo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><strong>Titulo:</strong> {{ objetivo.titulo}}</p>
            <p><strong>Descripcion:</strong> {{ objetivo.descripcion|default:"-"}}</p>
            <p><strong>Fecha de Creacion:</strong> {{ objetivo.fecha_creacion}}</p>
            <p><strong>Fecha de Asignacion:</strong> {{ objetivo.fecha_asignacion_representativa|default:"No asignado" }}</p>
            <p><strong>Fecha de Fin:</strong> {{objetivo.fecha_fin|default:"-"}}</p>
            <p><strong>Estado:</strong> {{ objetivo.estado_asignacion }}</p>
            <p><strong>Activo:</strong> 
              {% if objetivo.activo %}
                Sí
              {% else %}
                No
              {% endif %}
            </p>
            <p><strong>Recurrencia:</strong> 
              {% if objetivo.es_recurrente %}
                Siempre
              {% else %}
                Unica Vez
              {% endif %}
            </p>  
          </div>
        </div>
      </div>
    </div>
    {% endfor %}


    <!-- Modal para Confirmar Desactivacion -->
    <div class="modal fade" id="modalDesactivarObjetivo" tabindex="-1" aria-labelledby="modalDesactivarObjetivoLabel" aria-hidden="true">
      <div class="modal-dialog" style="margin-top: 12rem;">
        <div class="modal-content">
          <div class="modal-header" style="background-color: #3c8dbc;">
            <h5 class="modal-title text-white" id="modalDesactivarObjetivoLabel">Confirmar Desactivacion o Eliminacion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><span id="textoConfirmacionDesactivarObjetivo"></span></p>
          </div>
          <div class="modal-footer">
            <form id="formEliminarObjetivo" method="post">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Eliminar</button>
            </form>
            <form id="formDesactivarObjetivo" method="post">
              {% csrf_token %}
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" name="accion" value="desactivar" class="btn btn-warning">Desactivar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Confirmar Activación -->
    <div class="modal fade" id="modalActivarObjetivo" tabindex="-1" aria-labelledby="modalActivarObjetivoLabel" aria-hidden="true">
      <div class="modal-dialog" style="margin-top: 12rem;">
        <div class="modal-content">
          <div class="modal-header" style="background-color: #198754;"> <!-- verde bootstrap -->
            <h5 class="modal-title text-white" id="modalActivarObjetivoLabel">Confirmar Activación</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><span id="textoConfirmacionActivarObjetivo"></span></p>
          </div>
          <div class="modal-footer">
            <form id="formActivarObjetivo" method="post">
              {% csrf_token %}
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-success">Activar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        const modales = document.querySelectorAll('.modal');

        modales.forEach(modal => {
            modal.addEventListener('show.bs.modal', function () {
                const modalId = this.getAttribute('id');
                const objetivoId = modalId.replace('modalVerObjetivo', '');
                const historial = document.getElementById('historial' + objetivoId);
                
                if (historial && !historial.classList.contains('show')) {
                    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(historial);
                    bsCollapse.show();
                }
            });
        });
    
      
       const modalAsignar = document.getElementById('modalAsignarObjetivo');
      modalAsignar.addEventListener('hidden.bs.modal', function () {
          document.body.classList.remove('modal-open');
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) backdrop.remove();
      });
    });

    document.addEventListener('DOMContentLoaded', function () {
      const esRecurrenteCheckbox = document.getElementById('id_es_recurrente');
      const fechaFinInput = document.getElementById('id_fecha_fin');

      function toggleFechaFin() {
        if (esRecurrenteCheckbox.checked) {
          fechaFinInput.disabled = true;
          fechaFinInput.value = '';
        } else {
          fechaFinInput.disabled = false;
        }
      }

      esRecurrenteCheckbox.addEventListener('change', toggleFechaFin);

      toggleFechaFin();


      const modalAsignar = document.getElementById('modalAsignarObjetivo');

      modalAsignar.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget; 
        const objetivoId = button.getAttribute('data-objetivo-id');
        const objetivoTitulo = button.getAttribute('data-objetivo-titulo');

        document.getElementById('asignarObjetivoId').value = objetivoId;

       const tituloSpan = modalAsignar.querySelector('#tituloObjetivoAsignar');
        if (tituloSpan) {
          tituloSpan.textContent = objetivoTitulo;
        }
        
        document.getElementById('tipoAsignacion').value = '';
        mostrarSelectorAsignacion('');
      });

      const tipoAsignacionSelect = document.getElementById('tipo_asignacion');
      const contenedorEmpleado = document.getElementById('contenedor_empleado');
      const contenedorCargo = document.getElementById('contenedor_cargo');
      const empleadoSelect = document.getElementById('empleado_id');
      const cargoSelect = document.getElementById('cargo_id');

      function limpiarSelect(select) {
          select.innerHTML = '<option value="">Seleccione una opción</option>';
      }

      function cargarDatos(tipo) {
          fetch(`/objetivos/obtener_datos_asignacion/?tipo=${tipo}`)
              .then(response => response.json())
              .then(data => {
                  if (data.data) {
                      const targetSelect = (tipo === 'empleado') ? empleadoSelect : cargoSelect;
                      limpiarSelect(targetSelect);
                      data.data.forEach(obj => {
                          const option = document.createElement('option');
                          option.value = obj.id;
                          option.textContent = obj.nombre;
                          targetSelect.appendChild(option);
                      });
                  }
              });
      }

      tipoAsignacionSelect.addEventListener('change', function () {
          const tipo = this.value;
          if (tipo === 'empleado') {
              contenedorEmpleado.style.display = 'block';
              contenedorCargo.style.display = 'none';
          } else if (tipo === 'cargo') {
              contenedorEmpleado.style.display = 'none';
              contenedorCargo.style.display = 'block';
          } else {
              contenedorEmpleado.style.display = 'none';
              contenedorCargo.style.display = 'none';
          }

          if (tipo === 'empleado' || tipo === 'cargo') {
              cargarDatos(tipo);
          }
      });


      const tipoInicial = tipoAsignacionSelect.value;
      if (tipoInicial === 'empleado' || tipoInicial === 'cargo') {
          cargarDatos(tipoInicial);
          contenedorEmpleado.style.display = (tipoInicial === 'empleado') ? 'block' : 'none';
          contenedorCargo.style.display = (tipoInicial === 'cargo') ? 'block' : 'none';
      }

    });

    function mostrarSelectorAsignacion(valor) {
      document.getElementById("selectorEmpleado").classList.add("d-none");
      document.getElementById("selectorCargo").classList.add("d-none");

      if (valor === "empleado") {
        document.getElementById("selectorEmpleado").classList.remove("d-none");
      } else if (valor === "cargo") {
        document.getElementById("selectorCargo").classList.remove("d-none");
      }
    }

     // Mostrar segundo modal si fue solicitado
    {% if objetivo_para_asignar %}
      const asignarModal = new bootstrap.Modal(document.getElementById('modalAsignarObjetivo'));
      document.getElementById('asignarObjetivoId').value = "{{ objetivo_para_asignar.id }}";
      asignarModal.show();
    {% endif %}
  


  document.addEventListener("DOMContentLoaded", function () {
    
    const modalDesactivar = document.getElementById('modalDesactivarObjetivo');
    modalDesactivar.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const objetivoId = button.getAttribute('data-id');
      
      const formDesactivar = document.getElementById('formDesactivarObjetivo');
      formDesactivar.action = `/objetivos/${objetivoId}/desactivar/`;

      const formEliminar = document.getElementById('formEliminarObjetivo');
      formEliminar.action = `/objetivos/${objetivoId}/eliminar/`;

      const titulo = button.closest('tr').querySelector('td').textContent.trim();
      document.getElementById('textoConfirmacionDesactivarObjetivo').textContent = `¿Estás seguro de desactivar o eliminar el objetivo "${titulo}"?`;

    });

     const modalActivar = document.getElementById('modalActivarObjetivo');
    modalActivar.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const objetivoId = button.getAttribute('data-id');
      const form = document.getElementById('formActivarObjetivo');
      form.action = `/objetivos/${objetivoId}/activar/`;
      const titulo = button.closest('tr').querySelector('td').textContent.trim();
      document.getElementById('textoConfirmacionActivarObjetivo').textContent = `¿Estás seguro de activar el objetivo "${titulo}"?`;
    });

  });
    

  const urlParams = new URLSearchParams(window.location.search);
  const asignarId = urlParams.get('asignar');

  if (asignarId) {
      abrirModalAsignar(asignarId);

      urlParams.delete('asignar');
      const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
      window.history.replaceState({}, '', newUrl);
  }


    window.mostrarSelectorAsignacion = function(valor) {
      document.getElementById('selectorEmpleado').classList.toggle('d-none', valor !== 'empleado');
      document.getElementById('selectorCargo').classList.toggle('d-none', valor !== 'cargo');
    }




  function editarObjetivo(button) {
    const id = button.getAttribute('data-id');
    const titulo = button.getAttribute('data-titulo');
    const fechaFin = button.getAttribute('data-fechaFin');
    const descripcion = button.getAttribute('data-descripcion');
    const esRecurrente = button.getAttribute('data-esrecurrente') === 'True';


    // Llenar los campos del formulario
    document.getElementById('id_objetivo').value = id;
    document.getElementById('id_titulo').value = titulo;
    document.getElementById('id_descripcion').value = descripcion || '';
    document.getElementById('id_es_recurrente').checked = esRecurrente;

    if (fechaFin) {
      const fechaFormateada = new Date(fechaFin).toISOString().split('T')[0];
      document.getElementById('id_fecha_fin').value = fechaFormateada;
    } else {
      document.getElementById('id_fecha_fin').value = '';
    }

    document.getElementById('modalObjetivoLabel').textContent = "Editar Objetivo";
  }



  document.querySelector('button[data-bs-target="#modalObjetivo"]').addEventListener('click', function () {
    if (!this.hasAttribute('data-id')) {
      document.getElementById('formObjetivo').reset();
      document.getElementById('id_objetivo').value = '';
      document.getElementById('modalObjetivoLabel').textContent = "Crear Objetivo";
    }
  });



  function abrirModalAsignar(objetivoId) {
      const modal = new bootstrap.Modal(document.getElementById('modalAsignarObjetivo'));
      modal.show();

      document.getElementById('asignarObjetivoId').value = objetivoId;

      // Limpiar seleccionados
      document.querySelectorAll('#selectorEmpleado input[type="checkbox"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('#selectorCargo option').forEach(opt => opt.selected = false);

      // Traer asignaciones del objetivo
      fetch(`/objetivos/obtener_asignaciones_objetivo/?objetivo_id=${objetivoId}`)
          .then(response => response.json())
          .then(data => {
              if (data.empleados) {
                  data.empleados.forEach(id => {
                      const checkbox = document.getElementById('empleado' + id);
                      if (checkbox) checkbox.checked = true;
                  });
              }
              if (data.cargos) {
                  const select = document.getElementById('cargoSelect');
                  data.cargos.forEach(id => {
                      const option = select.querySelector(`option[value='${id}']`);
                      if (option) option.selected = true;
                  });
              }
          })
          .catch(err => console.error("Error fetch asignaciones:", err));
  }

  </script>

  {% endblock %}
</body>
</html>
