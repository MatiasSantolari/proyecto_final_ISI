{% extends "base.html" %}
{% load static %}

{% block title %}Gestión de Objetivos{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/badge_tables.css' %}">
<div class="container-fluid p-5 my-3">
    <h4 class="mb-3" style="color: var(--color-primario);">Gestión de Objetivos</h4>
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center mb-0">
            <button type="button" class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#modalObjetivo" onclick="limpiarFormularioParaCrear()">
                <i class="bi bi-plus-lg me-1"></i> Nuevo Objetivo
            </button>
        </div>
    </div>            

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" style="font-size: 0.95rem;">
                    <thead class="table-dark text-center">
                        <tr>
                            <th class="text-start ps-4" style="width: 35%;">Título / Descripción</th>
                            <th>Recurrencia</th>
                            <th>Creación</th>
                            <th>Vencimiento</th>
                            <th>Estado</th>
                            <th style="width: 12%;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="text-center">
                        {% for objetivo in objetivos %}
                        <tr>
                            <td class="text-start ps-4">
                                <div class="fw-bold text-truncate" style="max-width: 300px;">{{ objetivo.titulo }}</div>
                                <small class="text-muted d-block text-truncate" style="max-width: 300px;">{{ objetivo.descripcion|default:"-" }}</small>
                            </td>
                            <td>
                                {% if objetivo.es_recurrente %}
                                    <span class="badge bg-info text-dark"><i class="bi bi-arrow-repeat me-1"></i>Diario</span>
                                {% else %}
                                    <span class="text-muted small">Hito único</span>
                                {% endif %}
                            </td>
                            <td>{{ objetivo.fecha_creacion|date:"d/m/Y" }}</td>
                            <td>
                                {% if objetivo.fecha_fin %}
                                    <span class="{% if objetivo.fecha_fin < hoy %}text-danger fw-bold{% endif %}">
                                        {{ objetivo.fecha_fin|date:"d/m/Y" }}
                                    </span>
                                {% else %}
                                    <span class="text-muted small italic">Permanente</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if objetivo.activo %}
                                    <span class="badge bg-success shadow-sm" style="color: white !important;">Activo</span>
                                {% else %}
                                    <span class="badge bg-danger shadow-sm">Inactivo</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group shadow-sm">
                                    <button class="btn btn-sm btn-outline-info border-2 me-3" data-bs-toggle="modal" 
                                    data-bs-target="#modalVerObjetivo{{ objetivo.id }}" title="Ver Detalles">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    
                                    <button class="btn btn-sm btn-outline-primary border-2 me-3" 
                                    onclick="abrirModalAsignar({{ objetivo.id }}, '{{ objetivo.titulo }}')" title="Asignar">
                                        <i class="bi bi-person-plus"></i>
                                    </button>

                                    <button class="btn btn-sm btn-outline-secondary border-2 me-3" onclick="editarObjetivo(this)"
                                            data-id="{{ objetivo.id }}" data-titulo="{{ objetivo.titulo }}" 
                                            data-descripcion="{{ objetivo.descripcion }}" 
                                            data-fechafin="{{ objetivo.fecha_fin|date:'Y-m-d' }}" 
                                            data-esrecurrente="{{ objetivo.es_recurrente|yesno:'true,false' }}"
                                            title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>

                                    <button class="btn btn-sm  me-3 {% if objetivo.activo %}btn-outline-warning{% else %}btn-outline-success{% endif %} border-2" 
                                            onclick="confirmarAccion({{ objetivo.id }}, '{{ objetivo.titulo }}', '{% if objetivo.activo %}desactivar{% else %}activar{% endif %}')"
                                            title="{% if objetivo.activo %}Desactivar{% else %}Activar{% endif %}">
                                        <i class="bi {% if objetivo.activo %}bi-slash-circle{% else %}bi-arrow-clockwise{% endif %}"></i>
                                    </button>
                                    
                                    <button class="btn btn-sm btn-outline-danger border-2" 
                                            onclick="confirmarAccion({{ objetivo.id }}, '{{ objetivo.titulo }}', 'eliminar')"
                                            title="Eliminar">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="py-5 text-muted">No se encontraron objetivos registrados.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>

                <nav class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if objetivos.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ objetivos.previous_page_number }}">&laquo;</a>
                            </li>                        
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                        {% endif %}
                        {% for num in objetivos.paginator.page_range %}
                            <li class="page-item {% if objetivos.number == num %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                        {% endfor %}
                        {% if objetivos.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ objetivos.next_page_number }}">&raquo;</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>


<!--  Modal Crear/Editar -->
<div class="modal fade" id="modalObjetivo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <form method="post" action="{% url 'crear_objetivo' %}" id="formObjetivo">
                {% csrf_token %}
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="modalObjetivoLabel">Nuevo Objetivo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <input type="hidden" name="id_objetivo" id="id_objetivo">
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Título</label>
                        <input type="text" name="titulo" id="id_titulo" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Descripción</label>
                        <textarea name="descripcion" id="id_descripcion" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="bg-light p-4 rounded border shadow-sm">
                            <div class="form-check form-switch ms-1"> 
                                <input type="checkbox" name="es_recurrente" id="id_es_recurrente" class="form-check-input" style="cursor: pointer; width: 2.5em; height: 1.25em;">
                                <label class="form-check-label ms-3 fw-bold" for="id_es_recurrente">
                                    ¿Es un objetivo diario / recurrente?
                                </label>
                            </div>
                            <div class="form-text text-muted small ps-5">
                                Si se activa, el sistema generará esta tarea automáticamente cada día.
                            </div>
                        </div>
                    </div>

                    <div class="mb-3" id="contenedorFechaFin">
                        <label class="form-label fw-bold">Fecha de Fin (Vencimiento)</label>
                        <input type="date" name="fecha_fin" id="id_fecha_fin" class="form-control shadow-sm">
                    </div>


                </div>
                <div class="modal-footer bg-light">
                    <button type="submit" name="accion" value="guardar" class="btn btn-outline-success px-4">Guardar</button>
                    <button type="submit" name="accion" value="guardar_y_asignar" class="btn btn-primary px-4">Guardar y Asignar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ver Detalles -->
{% for objetivo in objetivos %}
<div class="modal fade" id="modalVerObjetivo{{ objetivo.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-dark">
                <h5 class="modal-title fw-bold">Detalle del Objetivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p><strong>Título:</strong> {{ objetivo.titulo }}</p>
                <p><strong>Descripción:</strong> {{ objetivo.descripcion|default:"-" }}</p>
                <p><strong>Fecha Creación:</strong> {{ objetivo.fecha_creacion|date:"d/m/Y" }}</p>
                <p><strong>Vencimiento:</strong> {{ objetivo.fecha_fin|date:"d/m/Y"|default:"Permanente" }}</p>
                <p><strong>Recurrencia:</strong> {% if objetivo.es_recurrente %}Si (Diario){% else %}No (Hito Único){% endif %}</p>
                <p><strong>Estado:</strong> {{ objetivo.activo|yesno:"Activo,Inactivo" }}</p>
            </div>
        </div>
    </div>
</div>
{% endfor %}


<div class="modal fade" id="modalAsignarObjetivo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" action="{% url 'asignar_objetivo' %}">
                {% csrf_token %}
                <input type="hidden" name="objetivo_id" id="asignarObjetivoId">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalAsignarObjetivoLabel">Asignar Objetivo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">1. Seleccione Departamento:</label>
                        <select id="modalFiltroDepto" class="form-select" onchange="cargarDatosDinamicos()">
                            <option value="">-- Seleccionar Departamento --</option>
                            {% for d in departamentos %}
                                <option value="{{ d.id }}">{{ d.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">2. Asignar a:</label>
                        <select id="tipoAsignacion" name="tipo_asignacion" class="form-select" onchange="cargarDatosDinamicos()" required>
                            <option value="">-- Seleccione Tipo --</option>
                            <option value="empleado">Empleado Específico</option>
                            <option value="cargo">Plantilla por Cargo</option>
                        </select>
                    </div>
                    <div id="selectorEmpleado" class="d-none mb-3">
                        <label class="form-label fw-bold">3. Seleccione Empleados:</label>
                        <div id="listaEmpleadosCheckbox" class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                        </div>
                    </div>
                    <div id="selectorCargo" class="d-none mb-3">
                        <label class="form-label fw-bold">3. Seleccione Cargo:</label>
                        <select name="cargo_id" id="cargoSelect" class="form-select">
                        </select>
                    </div>
                </div>

                <div class="modal-footer bg-light text-center">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">Confirmar Asignación</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--  Modal Confirmar Acción -->
<div class="modal fade" id="modalConfirmarAccion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-danger text-white" id="headerConfirmacion">
                <h5 class="modal-title">Confirmar Acción</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <p class="fs-5" id="textoConfirmacion"></p>
                <form id="formAccionObjetivo" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger px-4 fw-bold" id="btnConfirmarAccion">Confirmar</button>
                </form>
                <button type="button" class="btn btn-secondary px-4 ms-2" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const esRecurrente = document.getElementById('id_es_recurrente');
    const fechaFin = document.getElementById('id_fecha_fin');

    window.toggleFechaFin = function() {
        if (esRecurrente && fechaFin) {
            const estaChequeado = esRecurrente.checked;
            
            fechaFin.disabled = estaChequeado;

            if (estaChequeado) {
                fechaFin.value = '';
                fechaFin.style.backgroundColor = "#e9ecef"; 
                fechaFin.style.color = "#6c757d";
                fechaFin.style.cursor = "not-allowed";
            } else {
                fechaFin.style.backgroundColor = ""; 
                fechaFin.style.color = "";
                fechaFin.style.cursor = "default";
            }
        }
    }

    esRecurrente.addEventListener('change', toggleFechaFin);

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('asignar')) {
        abrirModalAsignar(urlParams.get('asignar'), 'Nuevo Objetivo');
    }
});


function cargarDatosDinamicos() {
    const deptoId = document.getElementById('modalFiltroDepto').value;
    const tipo = document.getElementById('tipoAsignacion').value;
    
    const divEmp = document.getElementById('selectorEmpleado');
    const divCargo = document.getElementById('selectorCargo');
    const listaEmp = document.getElementById('listaEmpleadosCheckbox');
    const selectCargo = document.getElementById('cargoSelect');

    divEmp.classList.add('d-none');
    divCargo.classList.add('d-none');

    if (!deptoId || !tipo) return;

    if (tipo === 'empleado') divEmp.classList.remove('d-none');
    if (tipo === 'cargo') divCargo.classList.remove('d-none');

    fetch(`/obtener-datos-depto/?depto_id=${deptoId}&tipo=${tipo}`)
        .then(response => response.json())
        .then(res => {
            if (tipo === 'empleado') {
                listaEmp.innerHTML = '';
                if (res.data.length > 0) {
                    res.data.forEach(e => {
                        listaEmp.innerHTML += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="empleado_id" value="${e.id}" id="emp${e.id}">
                                <label class="form-check-label" for="emp${e.id}">${e.nombre}</label>
                            </div>`;
                    });
                } else {
                    listaEmp.innerHTML = '<p class="text-danger small">No hay empleados vinculados a este departamento.</p>';
                }
            } else {
                selectCargo.innerHTML = '<option value="">-- Seleccionar Cargo --</option>';
                if (res.data.length > 0) {
                    res.data.forEach(c => {
                        selectCargo.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
                    });
                } else {
                    selectCargo.innerHTML = '<option value="">Sin cargos en este departamento</option>';
                }
            }
        });
}

// Resetear modal al abrir
function abrirModalAsignar(id, titulo) {
    document.getElementById('asignarObjetivoId').value = id;
    document.getElementById('modalAsignarObjetivoLabel').innerText = "Asignar: " + titulo;
    
    document.getElementById('modalFiltroDepto').value = '';
    document.getElementById('tipoAsignacion').value = '';
    document.getElementById('selectorEmpleado').classList.add('d-none');
    document.getElementById('selectorCargo').classList.add('d-none');
    
    new bootstrap.Modal(document.getElementById('modalAsignarObjetivo')).show();
}



function mostrarSelectorAsignacion(tipo) {
    document.getElementById('selectorEmpleado').classList.toggle('d-none', tipo !== 'empleado');
    document.getElementById('selectorCargo').classList.toggle('d-none', tipo !== 'cargo');
}

function editarObjetivo(btn) {
    const d = btn.dataset;
    document.getElementById('id_objetivo').value = d.id;
    document.getElementById('id_titulo').value = d.titulo;
    document.getElementById('id_descripcion').value = d.descripcion;
    document.getElementById('id_fecha_fin').value = d.fechafin;
    document.getElementById('id_es_recurrente').checked = d.esrecurrente === 'true';
    document.getElementById('modalObjetivoLabel').innerText = "Editar Objetivo";
    toggleFechaFin();
    new bootstrap.Modal(document.getElementById('modalObjetivo')).show();
}

function confirmarAccion(id, titulo, tipo) {
    const form = document.getElementById('formAccionObjetivo');
    const texto = document.getElementById('textoConfirmacion');
    const btn = document.getElementById('btnConfirmarAccion');
    const header = document.getElementById('headerConfirmacion');

    if (tipo === 'desactivar') {
        form.action = `/objetivos/desactivar/${id}/`;
        texto.innerHTML = `¿Desactivar objetivo <strong>${titulo}</strong>?`;
        btn.className = "btn btn-warning fw-bold";
        header.className = "modal-header bg-warning text-dark";
    } else if (tipo === 'activar') {
        form.action = `/objetivos/activar/${id}/`;
        texto.innerHTML = `¿Activar objetivo <strong>${titulo}</strong>?`;
        btn.className = "btn btn-success fw-bold";
        header.className = "modal-header bg-success text-white";
    } else {
        form.action = `/objetivos/eliminar/${id}/`;
        texto.innerHTML = `¿ELIMINAR PERMANENTEMENTE <strong>${titulo}</strong>?<br><small class="text-danger">Se perderá todo el historial.</small>`;
        btn.className = "btn btn-danger fw-bold";
        header.className = "modal-header bg-danger text-white";
    }
    new bootstrap.Modal(document.getElementById('modalConfirmarAccion')).show();
}

function limpiarFormularioParaCrear() {
    document.getElementById('formObjetivo').reset();
    document.getElementById('id_objetivo').value = '';
    document.getElementById('modalObjetivoLabel').innerText = "Nuevo Objetivo";
    toggleFechaFin();
}
</script>
{% endblock %}
