{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Informe de Asistencias{% endblock %}

{% block content %}
<div class="container my-5">
  <h3 class="mb-4" style="color: var(--color-primario);">Informe Completo de Asistencias</h3>

  <!-- Filtros -->
  <div class="row mb-4 g-2 align-items-end">
    <div class="col-md-3">
      <label class="form-label small">Departamento</label>
      <select id="departamentoFiltro" class="form-select form-select-sm">
        <option value="">Todos los departamentos</option>
        {% for dep in departamentos %}
        <option value="{{ dep.id }}">{{ dep.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label small">Periodo</label>
      <select id="periodoFiltro" class="form-select form-select-sm">
        <option value="hoy">Hoy</option>
        <option value="semana">Última Semana</option>
        <option value="mes">Último Mes</option>
        <option value="año">Último Año</option>
      </select>
    </div>
  </div>


  <div class="d-flex justify-content-between text-center gap-2 mb-3 mt-3">
    <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
      <div class="text-muted small">Total Empleados</div>
      <strong id="totalEmpleados" class="text-primary fs-5">0</strong>
    </div>
    <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
      <div class="text-muted small">Total Registros</div>
      <strong id="totalRegistros" class="text-info fs-5">0</strong>
    </div>
    <div class="p-1 rounded-3 bg-light flex-fill shadow-sm ml-3">
      <div class="text-muted small">Asistencias</div>
      <strong id="asistenciasConfirmadas" class="text-success fs-5">0</strong>
    </div>
    <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
      <div class="text-muted small">Tardanzas</div>
      <strong id="tardanzas" class="text-warning fs-5">0</strong>
    </div>
    <div class="p-1 rounded-3 bg-light flex-fill shadow-sm">
      <div class="text-muted small">Ausencias</div>
      <strong id="ausencias" class="text-danger fs-5">0</strong>
    </div>
  </div>


  <!-- Gráficos -->
  <div class="row mb-4">
    <div class="col-md-5">
      <canvas id="graficoAsistencias"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="graficoDepartamento"></canvas>
    </div>
  </div>


  <!-- Tabla detallada -->
  <div class="card shadow-sm border-0 mt-3">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-hover table-bordered align-middle mb-0" style="min-width: 900px; font-size: 0.9rem;">
          <thead class="table-light text-center">
            <tr>
              <th>Empleado</th>
              <th>Departamento</th>
              <th>Fecha</th>
              <th>Hora Entrada</th>
              <th>Hora Salida</th>
              <th>Tardanza</th>
              <th>Confirmado</th>
            </tr>
          </thead>
          <tbody id="tablaCuerpo" class="text-center">
          </tbody>
        </table>

        <nav aria-label="Paginación">
            <ul id="paginacion" class="pagination justify-content-center mt-4"></ul>
        </nav>

      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const ctx1 = document.getElementById('graficoAsistencias').getContext('2d');
    const ctx2 = document.getElementById('graficoDepartamento').getContext('2d');
    let graficoGeneral, graficoDepto;
    let paginaActual = 1;

    async function cargarDatos(pagina=1) {
        paginaActual = pagina;
        const dep = document.getElementById('departamentoFiltro').value;
        const periodo = document.getElementById('periodoFiltro').value;


        try {
            const response = await fetch(`{% url 'informe_asistencias_data' %}?departamento=${dep}&periodo=${periodo}&page=${pagina}`);
            const data = await response.json();

            document.getElementById('totalEmpleados').textContent = data.total_empleados || 0;
            document.getElementById('totalRegistros').textContent = data.total_registros || data.detalle.length || 0;
            document.getElementById('asistenciasConfirmadas').textContent = data.asistencias || 0;
            document.getElementById('tardanzas').textContent = data.tardanzas || 0;
            document.getElementById('ausencias').textContent = data.ausencias || 0;

            const tbody = document.getElementById('tablaCuerpo');
            tbody.innerHTML = '';

            if(data.detalle.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">No hay registros</td>
                    </tr>
                `;
            } else {
                data.detalle.forEach(item => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${item.empleado}</td>
                        <td>${item.departamento}</td>
                        <td>${item.fecha}</td>
                        <td>${item.hora_entrada || '-'}</td>
                        <td>${item.hora_salida || '-'}</td>
                        <td>${item.tardanza ? '⏰ Sí':'No'}</td>
                        <td>${item.confirmado ? '✅':'❌'}</td>
                    </tr>`;
                });
            }
    
            // Gráfico general
            if(graficoGeneral) graficoGeneral.destroy();
            graficoGeneral = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Asistencias', 'Tardanzas', 'Ausencias'],
                    datasets: [{
                        data: [data.asistencias, data.tardanzas, data.ausencias],
                        backgroundColor: ['#198754','#ffc107','#dc3545'],
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive:true,
                    animation: { animateScale:true, animateRotate:true }
                }
            });

            // Gráfico por departamento
            if(graficoDepto) graficoDepto.destroy();
            graficoDepto = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: data.departamentos_labels,
                    datasets: [
                        {label:'Asistencias', data:data.departamentos_asistencias, backgroundColor:'#198754'},
                        {label:'Tardanzas', data:data.departamentos_tardanzas, backgroundColor:'#ffc107'},
                        {label:'Ausencias', data:data.departamentos_ausencias, backgroundColor:'#dc3545'}
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1, 
                                precision: 0, 
                                callback: function(value) {
                                    return Number.isInteger(value) ? value : null; 
                                }
                            }
                        }
                    },
                    animation: { duration: 800 }
                }

            });

            // Paginación
            const pagNav = document.getElementById('paginacion');
            let html = '';

            if(data.paginator.has_previous){
                html += `<li class="page-item"><a class="page-link" href="#" onclick="cargarDatos(${data.paginator.previous_page_number});return false;">&laquo;</a></li>`;
            } else {
                html += `<li class="page-item disabled"><span class="page-link">&laquo;</span></li>`;
            }

            for(let i=1; i<=data.paginator.num_pages; i++){
                if(i === data.paginator.current_page){
                    html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
                } else {
                    html += `<li class="page-item"><a class="page-link" href="#" onclick="cargarDatos(${i});return false;">${i}</a></li>`;
                }
            }

            if(data.paginator.has_next){
                html += `<li class="page-item"><a class="page-link" href="#" onclick="cargarDatos(${data.paginator.next_page_number});return false;">&raquo;</a></li>`;
            } else {
                html += `<li class="page-item disabled"><span class="page-link">&raquo;</span></li>`;
            }

            pagNav.innerHTML = html;

        } catch(err) {
            console.error("Error al cargar datos de asistencias:", err);
        }
    }

    // Actualización automática al cambiar select
    document.getElementById('departamentoFiltro').addEventListener('change', ()=>cargarDatos(1));
    document.getElementById('periodoFiltro').addEventListener('change', ()=>cargarDatos(1));

    // Carga inicial
    cargarDatos();

  });


</script>

{% endblock %}
