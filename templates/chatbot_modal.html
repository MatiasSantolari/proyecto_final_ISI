{% load static %}

<link rel="stylesheet" href="{% static 'css/chatbot_modal.css' %}">

<div id="chatbot-button" class="chatbot-btn">
  <i class="bi bi-chat-dots-fill"></i>
  <span class="chatbot-tooltip">Chatbot RRHH</span>
</div>

<div id="chatbot-window" class="chatbot-window d-none">
  <div class="chatbot-header">
    <span>Chatbot RRHH</span>
    <div>
      <button id="clear-chat" class="chatbot-icon me-2" title="Limpiar chat">üóëÔ∏è</button>
      <button id="minimize-chat" class="chatbot-icon">‚Äî</button>
      <button id="close-chat" class="chatbot-icon">&times;</button>
    </div>
  </div>
  <div class="chatbot-body" id="chatbox"></div>
  <div class="chatbot-input">
    <input type="text" id="inputChat" placeholder="Escribe un mensaje...">
    <button onclick="sendMessage()">
      <i class="bi bi-send-fill"></i>
    </button>
  </div>
</div>


<script>
  const chatWindow = document.getElementById("chatbot-window");
  const chatButton = document.getElementById("chatbot-button");
  const closeChat = document.getElementById("close-chat");
  const minimizeChat = document.getElementById("minimize-chat");
  const clearChatButton = document.getElementById("clear-chat");
  const inputChat = document.getElementById("inputChat");
  let minimized = false;

  function saveChat(messages) {
    localStorage.setItem('hrChatHistory', JSON.stringify(messages));
  }

  function loadChat() {
    const chatbox = document.getElementById("chatbox");
    chatbox.innerHTML = ""; 
    const history = localStorage.getItem('hrChatHistory');
    if (history) {
      const messages = JSON.parse(history);
      messages.forEach(msg => {
        addMessage(msg.sender, msg.message, false);
      });
      chatbox.scrollTop = chatbox.scrollHeight;
    }
  }

  function clearChat() {
    localStorage.removeItem('hrChatHistory');
    document.getElementById("chatbox").innerHTML = ""; 
  }


  function saveChatWindowState() {
    const isOpen = !chatWindow.classList.contains("d-none");
    localStorage.setItem('hrChatWindowOpen', isOpen);
  }

  function loadChatWindowState() {
    const wasOpen = localStorage.getItem('hrChatWindowOpen') === 'true';
    if (wasOpen) {
      chatWindow.classList.remove("d-none");
      loadChat();
    }
  }


  chatButton.addEventListener("click", () => {
    chatWindow.classList.toggle("d-none");
    if (!chatWindow.classList.contains("d-none")) {
        loadChat();
    }
    saveChatWindowState();
  });


  closeChat.addEventListener("click", () => {
    chatWindow.classList.add("d-none");
    saveChatWindowState();
  });

  
  clearChatButton.addEventListener("click", clearChat);


  minimizeChat.addEventListener("click", () => {
    const body = chatWindow.querySelector(".chatbot-body");
    const input = chatWindow.querySelector(".chatbot-input");
    if (minimized) {
      body.style.display = "block";
      input.style.display = "flex";
      minimized = false;
    } else {
      body.style.display = "none";
      input.style.display = "none";
      minimized = true;
    }
  });


  function addMessage(sender, message, save = true) {
    let chatbox = document.getElementById("chatbox");
    let messageContainer = document.createElement("div");
    
    messageContainer.classList.add('chat-message');
    if (sender === 'user') {
        messageContainer.classList.add('user-message');
        messageContainer.innerHTML = "<b>T√∫:</b> " + message;
    } else {
        messageContainer.classList.add('bot-message');
        message = message.replace(/\n/g, "<br>");
        messageContainer.innerHTML = "<b>Bot:</b> " + message;
    }

    chatbox.appendChild(messageContainer);
    chatbox.scrollTop = chatbox.scrollHeight;

    if (save) {
        const history = JSON.parse(localStorage.getItem('hrChatHistory') || '[]');
        history.push({ sender: sender, message: message });
        saveChat(history);
    }
  }


  async function sendMessage() {
    let input = document.getElementById("inputChat");
    let message = input.value.trim();
    if (!message) return;
    input.value = "";
    addMessage('user', message);

    let chatbox = document.getElementById("chatbox");
    let loadingIndicator = document.createElement("div");
    loadingIndicator.id = "loading-indicator";
    loadingIndicator.innerHTML = "<b>Bot:</b> <i>Escribiendo...</i>";
    chatbox.appendChild(loadingIndicator);
    chatbox.scrollTop = chatbox.scrollHeight;

    let response = await fetch("{% url 'chatbot_response' %}", {
        method: "POST",
        credentials: "same-origin",
        headers: { "Content-Type": "application/json",
                  "X-CSRFToken": getCookie('csrftoken') },
        body: JSON.stringify({ message: message })
    });

    let data = await response.json();
    chatbox.removeChild(loadingIndicator); 
    addMessage('bot', data.response);
    chatbox.innerHTML += "<hr>"; 
  }


  inputChat.addEventListener("keydown", function(event) {
      if (event.key === "Enter") {
          event.preventDefault(); 
          sendMessage();
      }
  });


  loadChatWindowState();


  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

</script>
