{% extends "base.html" %}
{% load widget_tweaks %}
{% load static %}

<link rel="stylesheet" href="{% static 'css/user_perfil/user_perfil.css' %}">
 
  {% block content%}

      {% include "user_perfil-mi_perfil.html" %}

      <div id="editarPerfilContent">
      <div class="main-content d-flex justify-content-center mt-5">
        <div class="form-wrapper p-1 rounded shadow-sm" 
            style="max-width: 1000px; width: 100%; background-color: #f3f3f3ff;">

            <ul class="nav nav-tabs" id="perfilTabs" role="tablist"
              style="background-color: #ffffff; border-radius: 10px; padding: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
            
            <li class="nav-item me-auto"> 
              <button class="btn btn-outline-secondary btn-sm fw-bold" id="volverMiPerfilBtn"
                      type="button" style="border-radius: 8px;">
                <i class="bi bi-arrow-left me-1"></i> Volver a Mi Perfil
              </button> 
            </li>
            
            <li class="nav-item">
              <button class="nav-link fw-semibold" id="datos-personales-tab"
                      data-bs-toggle="tab" data-bs-target="#datos-personales" type="button" role="tab"
                      style="border-radius: 8px; margin-right: 5px;">
                <i class="bi bi-person-circle me-1"></i> Datos personales
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link fw-semibold" id="datos-academicos-tab"
                      data-bs-toggle="tab" data-bs-target="#datos-academicos" type="button" role="tab"
                      style="border-radius: 8px; margin-right: 5px;">
                <i class="bi bi-book me-1"></i> Datos académicos
              </button>
            </li>
              <li class="nav-item">
              <button class="nav-link fw-semibold" id="certificaciones-tab"
                      data-bs-toggle="tab" data-bs-target="#certificaciones" type="button" role="tab"
                      style="border-radius: 8px; margin-right: 5px;">
                <i class="bi bi-patch-check me-1"></i> Certificaciones
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link fw-semibold" id="experiencia-tab"
                      data-bs-toggle="tab" data-bs-target="#experiencia" type="button" role="tab"
                      style="border-radius: 8px;">
                <i class="bi bi-briefcase me-1"></i> Experiencia laboral
              </button>
            </li>
          </ul>


          <div class="tab-content">
            {% include "user_perfil-edit_datos_personales.html" %}
                    
            <div class="tab-pane fade p-2" id="datos-academicos" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3 p-1 bg-white rounded shadow-sm">
                    <p class="mb-0 fw-semibold text-muted">Aquí podrás ver tus datos académicos registrados.</p>
                    <button class="gradient-btn btn-academico d-flex align-items-center" id="addAcademicoBtn">
                        <i class="bi bi-plus me-1"></i> Nuevo
                    </button>
                </div>
                <div id="academicosContainer" class="row g-3 justify-content-center">
                 </div>
            </div>

        <div class="tab-pane fade p-2" id="certificaciones" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-white rounded shadow-sm">
              <p class="mb-0 fw-semibold text-muted">Aquí podrás registrar tus certificaciones.</p>
              <button class="gradient-btn btn-certificaciones d-flex align-items-center" id="addCertificacionBtn">
                  <i class="bi bi-plus me-1"></i> Nueva
              </button>
          </div>
          <div id="certificacionesContainer" class="row g-3 justify-content-center">
          </div>
        </div>

        <div class="tab-pane fade p-2" id="experiencia" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-white rounded shadow-sm">
              <p class="mb-0 fw-semibold text-muted">Aquí podrás registrar tu experiencia laboral.</p>
              <button class="gradient-btn btn-experiencia d-flex align-items-center" id="addExperienciaBtn">
                  <i class="bi bi-plus me-1"></i> Nuevo
              </button>
          </div>
          <div id="experienciasContainer" class="row g-3 justify-content-center">
          </div>
        </div>

          </div>
        </div>
      </div>
      </div>




      <div class="modal fade" id="confirmEliminarCvModal" tabindex="-1" aria-labelledby="confirmEliminarCvLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title" id="confirmEliminarCvLabel">¿Eliminar Currículum?</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              ¿Estás seguro que querés eliminar el currículum actual?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-danger fw-bold" id="confirmEliminarCvBtn"><i class="bi bi-trash3-fill me-1"></i>Eliminar</button>
            </div>
          </div>
        </div>
      </div>


      <!-- MODAL CONFIRMACIÓN -->
      <div class="modal fade" id="confirmSalirModal" tabindex="-1" aria-labelledby="confirmSalirLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmSalirLabel">¿Desea Salir?</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">¿Esta seguro que desea salir?<br> Si NO ha guardado los cambios se perderan.</div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-danger" id="confirmSalirBtn">Salir</button>
            </div>
          </div>
        </div>


<script>

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(c => {
            const cookie = c.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            }
        });
    }
    return cookieValue;
  }


  function seleccionarTab(tabId) {
    if (window.mostrarEditarPerfilGlobal) {
        window.mostrarEditarPerfilGlobal(tabId);
    } else {
        console.error("Window function not exposed yet.");
    }
  }


  window.onload = () => {
    const form = document.getElementById('perfilForm');
    const inputs = form.querySelectorAll('input, select, textarea');
    const miPerfilBtn = document.getElementById('miPerfilBtn');
    const editarBtn = document.getElementById('editarBtn');

    const miPerfilContent = document.getElementById('miPerfilContent');
    const editarPerfilContent = document.getElementById('editarPerfilContent');

    const cancelarBtn = document.getElementById('cancelarBtn');
    const botonesGestionar = document.querySelectorAll('.gradient-btn');
    const volverMiPerfilBtn = document.getElementById('volverMiPerfilBtn');

    const avatarInput = document.getElementById('id_avatar');
    const avatarContainer = document.getElementById('avatarContainerEdit');
    const avatarPlus = document.getElementById('avatarPlus');
    const editarAcciones = document.getElementById('editarAcciones');
    const tabs = document.querySelectorAll('#perfilTabs .nav-link');

    const seleccionarCVBtn = document.getElementById('seleccionarCVBtn');
    const inputCVitae = document.getElementById('id_cvitae');
    const cvitaeNombre = document.getElementById('cvitaeNombre');
    const eliminarCVBtn = document.getElementById('eliminarCVBtn');
    const verCVBtn = document.getElementById('verCVBtn');
    const confirmEliminarCvModalElement = document.getElementById('confirmEliminarCvModal');
    const confirmEliminarCvModal = confirmEliminarCvModalElement ? new bootstrap.Modal(confirmEliminarCvModalElement) : null;
    const confirmEliminarCvBtn = document.getElementById('confirmEliminarCvBtn');
    

    botonesGestionar.forEach(button => {
      button.addEventListener('click', (e) => {
          
        const tabIdRegex = button.getAttribute('onclick').match(/seleccionarTab\('(.+)'\)/);
          if (tabIdRegex && tabIdRegex[1]) {
              mostrarEditarPerfil(tabIdRegex[1]);
          }
      });
    });


    function actualizarAvatarEditable() {
      const tabActivo = document.querySelector('#perfilTabs .nav-link.active');
      if (!editarPerfilContent.classList.contains('d-none') &&
          tabActivo && tabActivo.id === 'datos-personales-tab' && avatarInput && avatarPlus && avatarContainer) {
        avatarInput.disabled = false;
        avatarPlus.style.display = 'flex';
        avatarContainer.style.cursor = 'pointer';
      } else if(avatarInput && avatarPlus && avatarContainer) {
        avatarInput.disabled = true;
        avatarPlus.style.display = 'none';
        avatarContainer.style.cursor = 'default';
      }
    }

    
    if (avatarContainer && avatarInput) {
      avatarContainer.addEventListener('click', () => {
        if (!avatarInput.disabled) avatarInput.click();
      });

      avatarInput.addEventListener('change', (event) => {
        const files = event.target.files;
        if (files && files.length > 0) {
          const file = files[0];
          const reader = new FileReader();
          
          reader.onload = e => {
            let preview = document.getElementById('previewAvatarEdit'); 
            const defaultIconDiv = document.getElementById('defaultAvatarIcon');
            
            if (defaultIconDiv) {
              const newImg = document.createElement('img');
              newImg.id = 'previewAvatarEdit';
              newImg.alt = 'Avatar Preview';
              avatarContainer.insertBefore(newImg, defaultIconDiv);
              avatarContainer.removeChild(defaultIconDiv);
              preview = newImg;
            }   
            preview.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
    }



    function mostrarEditarPerfil(tabId = null) {
      if (miPerfilContent && editarPerfilContent) {
        miPerfilContent.classList.add('d-none'); 
        editarPerfilContent.classList.remove('d-none'); 
      }

      if (editarBtn && miPerfilBtn) {
        editarBtn.classList.add('active');
        miPerfilBtn.classList.remove('active');
      }
      inputs.forEach(input => input.disabled = false);
      if (editarAcciones) editarAcciones.classList.remove('d-none');
      actualizarAvatarEditable();



      if (tabId) {
          const tabButton = document.querySelector(`[data-bs-target="#${tabId}"]`);
          if (tabButton) {
              const tabInstance = new bootstrap.Tab(tabButton);
              tabInstance.show();
              history.replaceState(null, '', `#editar-tab-${tabId}`);
          }
      } else {
          if (tabs.length > 0) {
              const primeraPestana = new bootstrap.Tab(tabs[0]);
              primeraPestana.show();
          }
          history.replaceState(null, '', '#editar');
      }
    }
    
    function mostrarMiPerfil() {
      if (miPerfilContent && editarPerfilContent) {
        miPerfilContent.classList.remove('d-none'); 
        editarPerfilContent.classList.add('d-none'); 
      }

      if (miPerfilBtn && editarBtn) {
          miPerfilBtn.classList.add('active');
          editarBtn.classList.remove('active');
      }
    
      inputs.forEach(input => input.disabled = true);
      if (editarAcciones) editarAcciones.classList.add('d-none');
      actualizarAvatarEditable();

      history.replaceState(null, '', '#perfil');
    }


      botonesGestionar.forEach(button => {
          button.addEventListener('click', (e) => {
              const tabIdRegex = button.getAttribute('onclick').match(/seleccionarTab\('(.+)'\)/);
              if (tabIdRegex && tabIdRegex[1]) {
                  mostrarEditarPerfil(tabIdRegex[1]);
              }
          });
      });



      if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const fechaNacimientoInput = document.getElementById('id_fecha_nacimiento');
            const generoSelect = document.getElementById('id_genero');
            
            if (fechaNacimientoInput) fechaNacimientoInput.disabled = false;
            if (generoSelect) generoSelect.disabled = false;
            
            const disabledInputs = form.querySelectorAll(':disabled');
            disabledInputs.forEach(input => {
                input.disabled = false;
            });

            const formData = new FormData(this); 
            
            disabledInputs.forEach(input => {
                input.disabled = true;
            });
            
            fetch(form.action || '/perfil/save/', { 
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            })
            .then(response => response.json()) 
            .then(data => {
                if (data.success) {
                  if (typeof mostrarToast === 'function') {
                      mostrarToast(data.toast_message || 'Acción exitosa', data.toast_type || 'success');
                  } else {
                      alert(data.toast_message || '¡Datos guardados exitosamente!');
                  }
                  mostrarMiPerfil(); 
                } else {
                    alert('Error al guardar: ' + (data.errors ? JSON.stringify(data.errors) : ''));
                }
            })
            .catch(error => {
              if (typeof mostrarToast === 'function') {
                  mostrarToast('Ocurrió un error de red o del servidor.', 'error');
              } else {
                  alert('Ocurrió un error de red o del servidor.');
              }
            });
        });
      }


    if (editarBtn) editarBtn.addEventListener('click', () => mostrarEditarPerfil());
    if (miPerfilBtn) miPerfilBtn.addEventListener('click', mostrarMiPerfil);
    if (cancelarBtn) cancelarBtn.addEventListener('click', mostrarMiPerfil);
    if (volverMiPerfilBtn) volverMiPerfilBtn.addEventListener('click', mostrarMiPerfil);
    
    tabs.forEach(tab => {
      tab.addEventListener('shown.bs.tab', (e) => {
        const id = e.target.getAttribute('data-bs-target').replace('#', '');
        history.replaceState(null, '', `#editar-tab-${id}`);
        actualizarAvatarEditable();
        if(typeof cerrarCardsAcademicoEnEdicion === 'function') cerrarCardsAcademicoEnEdicion();
        if(typeof cerrarCardsCertificacionEnEdicion === 'function') cerrarCardsCertificacionEnEdicion();
        if(typeof cerrarCardsExperienciaEnEdicion === 'function') cerrarCardsExperienciaEnEdicion();

        document.querySelectorAll('.tab-pane').forEach(panel => {
            if (panel.id !== id) {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block'; 
            }
        });

      });
    });


    
    if (seleccionarCVBtn && inputCVitae && cvitaeNombre) {
      seleccionarCVBtn.addEventListener('click', () => inputCVitae.click());
      inputCVitae.addEventListener('change', () => {
        if (inputCVitae.files.length > 0) cvitaeNombre.value = inputCVitae.files[0].name;
      });
    }
    if (eliminarCVBtn) eliminarCVBtn.addEventListener('click', () => confirmEliminarCvModal.show());
    if (confirmEliminarCvBtn) {
      confirmEliminarCvBtn.addEventListener('click', () => {
        cvitaeNombre.value = ''; inputCVitae.value = '';
        if (verCVBtn) verCVBtn.style.display = 'none';
        let inputHidden = document.querySelector('input[name="eliminar_cvitae"]');
        if (!inputHidden) {
          inputHidden = document.createElement('input'); inputHidden.type = 'hidden';
          inputHidden.name = 'eliminar_cvitae'; inputHidden.value = '1'; form.appendChild(inputHidden);
        }
        confirmEliminarCvModal.hide();
      });
    }

    window.seleccionarTab = (tabId) => {mostrarEditarPerfil(tabId);};

    window.mostrarEditarPerfilGlobal = mostrarEditarPerfil;
    const hash = window.location.hash;


    if (hash.startsWith('#editar-tab-')) {
      const tabId = hash.substring('#editar-tab-'.length);
      mostrarEditarPerfil(tabId);
    } else if (hash === '#editar') {
      mostrarEditarPerfil(); 
    } else {
      mostrarMiPerfil();   
    }

    if(typeof cargarDatosAcademicos === 'function') cargarDatosAcademicos();
    if(typeof cargarCertificaciones === 'function') cargarCertificaciones();
    if(typeof cargarExperiencias === 'function') cargarExperiencias();
  
  };




/////////////////

  function crearCardAcademico(dato = {}, modoVer = false) {
    const id = dato.id || '';
    const carrera = dato.carrera || '';
    const institucion = dato.institucion || '';
    const situacion = dato.situacion_academica || '';
    const fecha_inicio = dato.fecha_inicio || '';
    const fecha_fin = dato.fecha_fin || '';

    const card = document.createElement('div');
    card.classList.add('col-12');
    card.dataset.id = id;

    if (modoVer) {
        card.innerHTML = `
        <div class="card shadow-sm p-3 position-relative" style="max-width: 950px;">
            <div class="d-flex">
                <div class="me-4 d-flex align-items-center">
                    <i class="bi bi-mortarboard-fill fs-1 text-primary"></i>
                </div>
                <div>
                    <h5 class="fw-bold mb-1">${carrera}</h5>
                    <p class="mb-1"><i class="bi bi-building me-1"></i> ${institucion}</p>
                    <p class="mb-1"><i class="bi bi-clipboard-check me-1"></i> Situación académica: ${situacion}</p>
                    <p class="mb-0"><i class="bi bi-calendar-event me-1"></i> Inicio: ${fecha_inicio}</p>
                    <p class="mb-0"><i class="bi bi-calendar-event me-1"></i> Fin: ${fecha_fin || '--'}</p>
                </div>
            </div>
            <button class="btn btn-sm btn-primary position-absolute top-0 end-0 m-2 editarAcademicoBtn">
                <i class="bi bi-pencil"></i>
            </button>
        </div>
        `;
    } else {
        card.innerHTML = `
        <div class="card shadow-sm p-3 position-relative" style="max-width: 950px;">
            <div class="d-flex">
                <div class="me-4 d-flex align-items-center">
                    <i class="bi bi-mortarboard-fill fs-1 text-primary"></i>
                </div>
                <div class="flex-grow-1">
                    <input type="hidden" class="datoAcademicoId" value="${id}">
                    <input type="text" class="form-control mb-2 carreraAcademico" placeholder="Nombre de la carrera" value="${carrera}">
                    <input type="text" class="form-control mb-2 institucionAcademico" placeholder="Institución" value="${institucion}">
                    <select class="form-select mb-2 situacionAcademico">
                        <option value="">Seleccionar situación</option>
                        <option value="cursando" ${situacion === 'cursando' ? 'selected' : ''}>Cursando</option>
                        <option value="finalizado" ${situacion === 'finalizado' ? 'selected' : ''}>Finalizado</option>
                        <option value="abandonado" ${situacion === 'abandonado' ? 'selected' : ''}>Abandonado</option>
                    </select>
                    <div class="d-flex gap-2 mb-2">
                        <input type="date" class="form-control fechaInicioAcademico" value="${fecha_inicio}">
                        <input type="date" class="form-control fechaFinAcademico" value="${fecha_fin}">
                    </div>
                </div>
            </div>
            <div class="d-flex align-items-center mt-3">
              <div class="d-flex gap-2">
                <button class="btn btn-success guardarAcademicoBtn">Guardar</button>
                <button class="btn btn-secondary cancelarAcademicoBtn">Cancelar</button>
              </div>
                ${id ? '<button class="btn btn-danger eliminarAcademicoBtn ms-auto">Eliminar</button>' : ''}
            </div>
        </div>
        `;
    }

    return card;
  }


  function cargarDatosAcademicos() {
      fetch('/perfil/datos-academicos/list/')
          .then(res => res.json())
          .then(data => {
              const container = document.getElementById('academicosContainer');
              container.innerHTML = '';
              data.datos.forEach(dato => {
                  const card = crearCardAcademico(dato, true);
                  container.appendChild(card);
                  agregarEventosCardAcademico(card);
              });
          });
  }


  function bloquearFechaFinAcademico(card) {
      const selectSituacion = card.querySelector('.situacionAcademico');
      const fechaFin = card.querySelector('.fechaFinAcademico');

      if (!selectSituacion || !fechaFin) return;

      function actualizar() {
          const valor = selectSituacion.value;
          if (valor === 'cursando' || valor === 'abandonado') {
              fechaFin.value = '';
              fechaFin.disabled = true;
          } else {
              fechaFin.disabled = false;
          }
      }

      selectSituacion.addEventListener('change', actualizar);
      actualizar(); 
  }



  function agregarEventosCardAcademico(card) {

    bloquearFechaFinAcademico(card);

    const guardarBtn = card.querySelector('.guardarAcademicoBtn');
    const cancelarBtn = card.querySelector('.cancelarAcademicoBtn');
    const eliminarBtn = card.querySelector('.eliminarAcademicoBtn');
    const editarBtn = card.querySelector('.editarAcademicoBtn');

    if (guardarBtn) {
        guardarBtn.addEventListener('click', () => {
            const formData = new FormData();
            formData.append('id', card.querySelector('.datoAcademicoId').value);
            formData.append('carrera', card.querySelector('.carreraAcademico').value);
            formData.append('institucion', card.querySelector('.institucionAcademico').value);
            formData.append('situacion_academica', card.querySelector('.situacionAcademico').value);
            formData.append('fecha_inicio', card.querySelector('.fechaInicioAcademico').value);
            formData.append('fecha_fin', card.querySelector('.fechaFinAcademico').value);

            fetch('/perfil/datos-academicos/save/', {
                method: 'POST',
                body: formData,
                headers: {'X-CSRFToken': getCookie('csrftoken')}
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (typeof mostrarToast === 'function') {
                          mostrarToast(data.toast_message, data.toast_type || 'success');
                      }
                    const newCard = crearCardAcademico({
                        id: data.id,
                        carrera: formData.get('carrera'),
                        institucion: formData.get('institucion'),
                        situacion_academica: formData.get('situacion_academica'),
                        fecha_inicio: formData.get('fecha_inicio'),
                        fecha_fin: formData.get('fecha_fin')
                    }, true);
                    card.replaceWith(newCard);
                    agregarEventosCardAcademico(newCard);
                } else {
                    alert('Error: ' + JSON.stringify(data.errors));
                }
            });
        });
      }

    if (cancelarBtn) {
        cancelarBtn.addEventListener('click', () => {
          cargarDatosAcademicos();
      });
    }

    if (eliminarBtn) {
      eliminarBtn.addEventListener('click', () => {
          const id = card.querySelector('.datoAcademicoId').value;
          const formData = new FormData();
          formData.append('id', id);

          fetch('/perfil/datos-academicos/delete/', {
              method: 'POST',
              body: formData,
              headers: {'X-CSRFToken': getCookie('csrftoken')}
          })
          .then(res => res.json())
          .then(data => {
              if (data.success) {
                if (typeof mostrarToast === 'function') {
                    mostrarToast(data.toast_message, data.toast_type || 'success');
                }
                cargarDatosAcademicos();
              } else {
                  alert('Error: ' + data.error);
              }
          });
      });
    }

    if (editarBtn) {
      editarBtn.addEventListener('click', () => {
        
        cerrarCardsAcademicoEnEdicion();

        const datos = {
            id: card.dataset.id || '',
            carrera: card.querySelector('h5')?.textContent || '',
            institucion: card.querySelector('p')?.childNodes[1]?.textContent.trim() || '',
            situacion_academica: card.querySelectorAll('p')[1]?.textContent.split(': ')[1].toLowerCase() || '',
            fecha_inicio: card.querySelectorAll('p')[2]?.textContent.split(': ')[1] || '',
            fecha_fin: card.querySelectorAll('p')[3]?.textContent.split(': ')[1] === '--' ? '' : card.querySelectorAll('p')[3]?.textContent.split(': ')[1]
        };

        const newCard = crearCardAcademico(datos, false);
        card.replaceWith(newCard);
        agregarEventosCardAcademico(newCard);
    });
  }
}


function cerrarCardsAcademicoEnEdicion() {
  document.querySelectorAll('#academicosContainer .col-12').forEach(c => {
      const guardarBtn = c.querySelector('.guardarAcademicoBtn');

      const id = c.querySelector('.datoAcademicoId')?.value || '';
      if (guardarBtn && !id) {
          c.remove();
          return;
      }

      if (guardarBtn && id) {
          const carrera = c.querySelector('.carreraAcademico')?.value || '';
          const institucion = c.querySelector('.institucionAcademico')?.value || '';
          const situacion = c.querySelector('.situacionAcademico')?.value || '';
          const fecha_inicio = c.querySelector('.fechaInicioAcademico')?.value || '';
          const fecha_fin = c.querySelector('.fechaFinAcademico')?.value || '';

          const datos = { id, carrera, institucion, situacion_academica: situacion, fecha_inicio, fecha_fin };
          const verCard = crearCardAcademico(datos, true);
          c.replaceWith(verCard);
          agregarEventosCardAcademico(verCard);
      }
  });
}



if (document.getElementById('addAcademicoBtn')) {
  document.getElementById('addAcademicoBtn').addEventListener('click', () => {
    cerrarCardsAcademicoEnEdicion();
    const container = document.getElementById('academicosContainer');
      const card = crearCardAcademico({}, false);
      container.prepend(card);
      agregarEventosCardAcademico(card);
  });
}




////////////////////

  function crearCardCertificacion(dato = {}, modoVer = false) {
      const id = dato.id || '';
      const nombre = dato.nombre || '';
      const institucion = dato.institucion || '';
      const fecha_inicio = dato.fecha_inicio || '';
      const fecha_fin = dato.fecha_fin || '';

      const card = document.createElement('div');
      card.classList.add('col-12');
      card.dataset.id = id;

      if (modoVer) {
          card.innerHTML = `
          <div class="card shadow-sm p-3 position-relative" style="max-width: 950px;">
              <div class="d-flex">
                  <div class="me-4 d-flex align-items-center">
                      <i class="bi bi-award-fill fs-1 text-warning"></i>
                  </div>
                  <div>
                      <h5 class="fw-bold mb-1">${nombre}</h5>
                      <p class="mb-1"><i class="bi bi-building me-1"></i> ${institucion}</p>
                      <p class="mb-0"><i class="bi bi-calendar-event me-1"></i> Inicio: ${fecha_inicio}</p>
                      <p class="mb-0"><i class="bi bi-calendar-event me-1"></i> Fin: ${fecha_fin || '--'}</p>
                  </div>
              </div>
              <button class="btn btn-sm btn-primary position-absolute top-0 end-0 m-2 editarCertificacionBtn">
                  <i class="bi bi-pencil"></i>
              </button>
          </div>
          `;
      } else {
          card.innerHTML = `
          <div class="card shadow-sm p-3 position-relative" style="max-width: 950px;">
              <div class="d-flex">
                  <div class="me-4 d-flex align-items-center">
                      <i class="bi bi-award-fill fs-1 text-warning"></i>
                  </div>
                  <div class="flex-grow-1">
                      <input type="hidden" class="datoCertificacionId" value="${id}">
                      <input type="text" class="form-control mb-2 nombreCertificacion" placeholder="Nombre de la certificación" value="${nombre}">
                      <input type="text" class="form-control mb-2 institucionCertificacion" placeholder="Institución" value="${institucion}">
                      <div class="d-flex gap-2 mb-2">
                          <input type="date" class="form-control fechaInicioCertificacion" value="${fecha_inicio}">
                          <input type="date" class="form-control fechaFinCertificacion" value="${fecha_fin}">
                      </div>
                  </div>
              </div>
              <div class="d-flex align-items-center mt-3">
                <div class="d-flex gap-2">
                  <button class="btn btn-success guardarCertificacionBtn">Guardar</button>
                  <button class="btn btn-secondary cancelarCertificacionBtn">Cancelar</button>
                </div>
                  ${id ? '<button class="btn btn-danger eliminarCertificacionBtn ms-auto">Eliminar</button>' : ''}
              </div>
          </div>
          `;
      }

      return card;
  }

  function cargarCertificaciones() {
      fetch('/perfil/certificaciones/list/')
          .then(res => res.json())
          .then(data => {
              const container = document.getElementById('certificacionesContainer');
              container.innerHTML = '';
              data.datos.forEach(dato => {
                  const card = crearCardCertificacion(dato, true);
                  container.appendChild(card);
                  agregarEventosCardCertificacion(card);
              });
          });
  }

  function agregarEventosCardCertificacion(card) {
      const guardarBtn = card.querySelector('.guardarCertificacionBtn');
      const cancelarBtn = card.querySelector('.cancelarCertificacionBtn');
      const eliminarBtn = card.querySelector('.eliminarCertificacionBtn');
      const editarBtn = card.querySelector('.editarCertificacionBtn');

      if (guardarBtn) {
          guardarBtn.addEventListener('click', () => {
              const formData = new FormData();
              formData.append('id', card.querySelector('.datoCertificacionId').value);
              formData.append('nombre', card.querySelector('.nombreCertificacion').value);
              formData.append('institucion', card.querySelector('.institucionCertificacion').value);
              formData.append('fecha_inicio', card.querySelector('.fechaInicioCertificacion').value);
              formData.append('fecha_fin', card.querySelector('.fechaFinCertificacion').value);

              fetch('/perfil/certificaciones/save/', {
                  method: 'POST',
                  body: formData,
                  headers: { 'X-CSRFToken': getCookie('csrftoken') }
              })
                  .then(res => res.json())
                  .then(data => {
                      if (data.success) {
                          if (typeof mostrarToast === 'function') {
                              mostrarToast(data.toast_message, data.toast_type || 'success');
                          }
                          const newCard = crearCardCertificacion({
                              id: data.id,
                              nombre: formData.get('nombre'),
                              institucion: formData.get('institucion'),
                              fecha_inicio: formData.get('fecha_inicio'),
                              fecha_fin: formData.get('fecha_fin')
                          }, true);
                          card.replaceWith(newCard);
                          agregarEventosCardCertificacion(newCard);
                      } else {
                          alert('Error: ' + JSON.stringify(data.errors));
                      }
                  });
          });
      }

      if (cancelarBtn) {
          cancelarBtn.addEventListener('click', () => {
              cargarCertificaciones();
          });
      }

      if (eliminarBtn) {
          eliminarBtn.addEventListener('click', () => {
              const id = card.querySelector('.datoCertificacionId').value;
              const formData = new FormData();
              formData.append('id', id);

              fetch('/perfil/certificaciones/delete/', {
                  method: 'POST',
                  body: formData,
                  headers: { 'X-CSRFToken': getCookie('csrftoken') }
              })
                  .then(res => res.json())
                  .then(data => {
                      if (data.success) {
                          if (typeof mostrarToast === 'function') {
                              mostrarToast(data.toast_message, data.toast_type || 'success');
                          }
                          cargarCertificaciones();
                      } else {
                          alert('Error: ' + data.error);
                      }
                  });
          });
      }

      if (editarBtn) {
          editarBtn.addEventListener('click', () => {
              cerrarCardsCertificacionEnEdicion();
    
              const datos = {
                  id: card.dataset.id || '',
                  nombre: card.querySelector('h5')?.textContent || '',
                  institucion: card.querySelector('p')?.childNodes[1]?.textContent.trim() || '',
                  fecha_inicio: card.querySelectorAll('p')[1]?.textContent.split(': ')[1] || '',
                  fecha_fin: card.querySelectorAll('p')[2]?.textContent.split(': ')[1] === '--' ? '' : card.querySelectorAll('p')[2]?.textContent.split(': ')[1]
              };

              const newCard = crearCardCertificacion(datos, false);
              card.replaceWith(newCard);
              agregarEventosCardCertificacion(newCard);
          });
      }
  }

  function cerrarCardsCertificacionEnEdicion() {
      document.querySelectorAll('#certificacionesContainer .col-12').forEach(c => {
          const guardarBtn = c.querySelector('.guardarCertificacionBtn');
          const id = c.querySelector('.datoCertificacionId')?.value || '';

          if (guardarBtn && !id) {
              c.remove();
              return;
          }

          if (guardarBtn && id) {
              const nombre = c.querySelector('.nombreCertificacion')?.value || '';
              const institucion = c.querySelector('.institucionCertificacion')?.value || '';
              const fecha_inicio = c.querySelector('.fechaInicioCertificacion')?.value || '';
              const fecha_fin = c.querySelector('.fechaFinCertificacion')?.value || '';

              const datos = { id, nombre, institucion, fecha_inicio, fecha_fin };
              const verCard = crearCardCertificacion(datos, true);
              c.replaceWith(verCard);
              agregarEventosCardCertificacion(verCard);
          }
      });
  }



  if (document.getElementById('addCertificacionBtn')) {
      document.getElementById('addCertificacionBtn').addEventListener('click', () => {
          cerrarCardsCertificacionEnEdicion();
          const container = document.getElementById('certificacionesContainer');
          const card = crearCardCertificacion({}, false);
          container.prepend(card);
          agregarEventosCardCertificacion(card);
      });
  }



////////////////////

  function crearCardExperiencia(dato = {}, modoVer = false) {
      const id = dato.id || '';
      const cargo_exp = dato.cargo_exp || '';
      const empresa = dato.empresa || '';
      const descripcion = dato.descripcion || '';
      const fecha_inicio = dato.fecha_inicio || '';
      const fecha_fin = dato.fecha_fin || '';
      const actualidad = dato.actualidad || false;

      const card = document.createElement('div');
      card.classList.add('col-12');
      card.dataset.id = id;

      if (modoVer) {
          card.innerHTML = `
          <div class="card shadow-sm p-3 position-relative" style="max-width: 950px;">
              <div class="d-flex">
                  <div class="me-4 d-flex align-items-center">
                      <i class="bi bi-briefcase-fill fs-1 text-primary"></i>
                  </div>
                  <div>
                      <h5 class="fw-bold mb-1">${cargo_exp}</h5>
                      <p class="mb-1"><i class="bi bi-building me-1"></i> ${empresa}</p>
                      <p class="mb-1"><i class="bi bi-calendar-event me-1"></i> Inicio: ${fecha_inicio}</p>
                      <p class="mb-1"><i class="bi bi-calendar-event me-1"></i> Fin: ${actualidad ? 'Actualidad' : (fecha_fin || '--')}</p>
                      <p class="mb-0"><i class="bi bi-card-text me-1"></i> ${descripcion || ''}</p>
                  </div>
              </div>
              <button class="btn btn-sm btn-primary position-absolute top-0 end-0 m-2 editarExperienciaBtn">
                  <i class="bi bi-pencil"></i>
              </button>
          </div>
          `;
      } else {
          card.innerHTML = `
          <div class="card shadow-sm p-3 position-relative" style="max-width: 950px;">
              <input type="hidden" class="datoExperienciaId" value="${id}">
              <input type="text" class="form-control mb-2 cargo_expExperiencia" placeholder="Cargo_exp" value="${cargo_exp}">
              <input type="text" class="form-control mb-2 empresaExperiencia" placeholder="Empresa" value="${empresa}">
              <textarea class="form-control mb-2 descripcionExperiencia" placeholder="Descripción">${descripcion}</textarea>
              <div class="d-flex gap-2 mb-2">
                  <input type="date" class="form-control fechaInicioExperiencia" value="${fecha_inicio}">
                  <input type="date" class="form-control fechaFinExperiencia" value="${fecha_fin}" ${actualidad ? 'disabled' : ''}>
              </div>
              <div class="form-check mb-4">
                  <input class="form-check-input actualidadExperiencia" type="checkbox" ${actualidad ? 'checked' : ''}>
                  <label class="form-check-label">Actualmente trabajando aquí</label>
              </div>
              <div class="d-flex align-items-center mt-2">
                <div class="d-flex gap-2">
                  <button class="btn btn-success guardarExperienciaBtn">Guardar</button>
                  <button class="btn btn-secondary cancelarExperienciaBtn">Cancelar</button>
                </div>
                  ${id ? '<button class="btn btn-danger eliminarExperienciaBtn ms-auto">Eliminar</button>' : ''}
              </div>
          </div>
          `;
      }

      return card;
  }

  function bloquearFechaFinExperiencia(card) {
      const chk = card.querySelector('.actualidadExperiencia');
      const fechaFin = card.querySelector('.fechaFinExperiencia');
      if (!chk || !fechaFin) return;

      function actualizar() {
          if (chk.checked) {
              fechaFin.value = '';
              fechaFin.disabled = true;
          } else {
              fechaFin.disabled = false;
          }
      }
      chk.addEventListener('change', actualizar);
      actualizar();
  }

  function agregarEventosCardExperiencia(card) {
      bloquearFechaFinExperiencia(card);

      const guardarBtn = card.querySelector('.guardarExperienciaBtn');
      const cancelarBtn = card.querySelector('.cancelarExperienciaBtn');
      const eliminarBtn = card.querySelector('.eliminarExperienciaBtn');
      const editarBtn = card.querySelector('.editarExperienciaBtn');

      if (guardarBtn) {
          guardarBtn.addEventListener('click', () => {
              const formData = new FormData();
              formData.append('id', card.querySelector('.datoExperienciaId').value);
              formData.append('cargo_exp', card.querySelector('.cargo_expExperiencia').value);
              formData.append('empresa', card.querySelector('.empresaExperiencia').value);
              formData.append('descripcion', card.querySelector('.descripcionExperiencia').value);
              formData.append('fecha_inicio', card.querySelector('.fechaInicioExperiencia').value);
              formData.append('fecha_fin', card.querySelector('.fechaFinExperiencia').value);
              formData.append('actualidad', card.querySelector('.actualidadExperiencia').checked ? 'true' : 'false');

              fetch('/perfil/experiencias/save/', {
                  method: 'POST',
                  body: formData,
                  headers: {'X-CSRFToken': getCookie('csrftoken')}
              })
              .then(res => res.json())
              .then(data => {
                  if (data.success) {
                      if (typeof mostrarToast === 'function') {
                          mostrarToast(data.toast_message, data.toast_type || 'success');
                      }
                      const newCard = crearCardExperiencia({
                          id: data.id,
                          cargo_exp: formData.get('cargo_exp'),
                          empresa: formData.get('empresa'),
                          descripcion: formData.get('descripcion'),
                          fecha_inicio: formData.get('fecha_inicio'),
                          fecha_fin: formData.get('fecha_fin'),
                          actualidad: formData.get('actualidad') === 'true'
                      }, true);
                      card.replaceWith(newCard);
                      agregarEventosCardExperiencia(newCard);
                  } else {
                      alert('Error: ' + JSON.stringify(data.errors));
                  }
              });
          });
      }

      if (cancelarBtn) cancelarBtn.addEventListener('click', cargarExperiencias);

      if (eliminarBtn) {
          eliminarBtn.addEventListener('click', () => {
              const id = card.querySelector('.datoExperienciaId').value;
              const formData = new FormData();
              formData.append('id', id);

              fetch('/perfil/experiencias/delete/', {
                  method: 'POST',
                  body: formData,
                  headers: {'X-CSRFToken': getCookie('csrftoken')}
              })
              .then(res => res.json())
              .then(data => {
                  if (data.success) {
                    if (typeof mostrarToast === 'function') {
                        mostrarToast(data.toast_message, data.toast_type || 'success');
                    }
                    cargarExperiencias();
                  } else { 
                    alert('Error: ' + data.error);
                  }
              });
          });
      }

      if (editarBtn) {
          editarBtn.addEventListener('click', () => {
              cerrarCardsExperienciaEnEdicion();

              const datos = {
                  id: card.dataset.id || '',
                  cargo_exp: card.querySelector('h5')?.textContent || '',
                  empresa: card.querySelectorAll('p')[0]?.textContent.split(' ').slice(1).join(' ') || '',
                  descripcion: card.querySelectorAll('p')[3]?.textContent?.trim() || '',
                  fecha_inicio: card.querySelectorAll('p')[1]?.textContent.split(': ')[1] || '',
                  fecha_fin: card.querySelectorAll('p')[2]?.textContent.split(': ')[1] === 'Actualidad' ? '' : card.querySelectorAll('p')[2]?.textContent.split(': ')[1],
                  actualidad: card.querySelectorAll('p')[2]?.textContent.split(': ')[1] === 'Actualidad'
              };

              const newCard = crearCardExperiencia(datos, false);
              card.replaceWith(newCard);
              agregarEventosCardExperiencia(newCard);
          });
      }
  }


  function cerrarCardsExperienciaEnEdicion() {
    const cards = document.querySelectorAll('#experienciasContainer .card');

    cards.forEach(card => {
      const id = card.querySelector('.datoExperienciaId')?.value || '';
      const cargoInput = card.querySelector('.cargo_expExperiencia');

      if (!cargoInput) return;

      const empresaVal = card.querySelector('.empresaExperiencia')?.value.trim() || '';
      const descripcionVal = card.querySelector('.descripcionExperiencia')?.value.trim() || '';
      const fechaInicioVal = card.querySelector('.fechaInicioExperiencia')?.value.trim() || '';
      const fechaFinVal = card.querySelector('.fechaFinExperiencia')?.value.trim() || '';
      const cargoVal = cargoInput.value.trim() || '';

      const sinDatos = !id && !empresaVal && !descripcionVal && !fechaInicioVal && !fechaFinVal && !cargoVal;
      if (sinDatos) {
        card.remove();
        return;
      }

      const datos = {
        id: id,
        cargo_exp: cargoVal,
        empresa: empresaVal,
        descripcion: descripcionVal,
        fecha_inicio: fechaInicioVal,
        fecha_fin: fechaFinVal,
        actualidad: card.querySelector('.actualidadExperiencia')?.checked || false
      };

      const newCard = crearCardExperiencia(datos, true);
      card.replaceWith(newCard);
      agregarEventosCardExperiencia(newCard);
    });
  }

  
  function cargarExperiencias() {
      fetch('/perfil/experiencias/list/')
          .then(res => res.json())
          .then(data => {
              const container = document.getElementById('experienciasContainer');
              container.innerHTML = '';
              data.datos.forEach(dato => {
                  const card = crearCardExperiencia(dato, true);
                  container.appendChild(card);
                  agregarEventosCardExperiencia(card);
              });
          });
  }



  if (document.getElementById('addExperienciaBtn')) {
      document.getElementById('addExperienciaBtn').addEventListener('click', () => {
          cerrarCardsExperienciaEnEdicion();
          const container = document.getElementById('experienciasContainer');
          const card = crearCardExperiencia({}, false);
          container.prepend(card);
          agregarEventosCardExperiencia(card);
      });
  }

  window.seleccionarTab = seleccionarTab;

</script>

{% endblock %}
</body>