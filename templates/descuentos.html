{% extends "base.html"%}
{% load widget_tweaks %}

  {% block title %}Gestión de Descuentos{% endblock %}
  
  {% block content %}

  <div class="container my-5"><hv><hv>
    <h1 class="mb-4" style="color: var(--color-primario);">Gestión de Descuentos</h1>

    <!-- Botón para Crear -->
    <button type="button" class="btn mb-3 btn-primary" data-bs-toggle="modal" data-bs-target="#modalDescuento">
      + Crear Nuevo Tipo de Descuento
    </button>

    <!-- Tabla de Descuentos -->
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-hover table-bordered align-middle mb-0" style="min-width: 1000px; font-size: 0.95rem;">
            <thead class="table-light text-center">
              <tr>
                <th>Descripción</th>
                <th>Monto</th>
                <th style="width: 12%">Porcentaje</th>
                <th style="width: 10%">Activo</th>
                <th style="width: 10%">Fijo</th>
                <th style="width: 12%">Acciones</th>
              </tr>
            </thead>
            <tbody class="text-center">
              {% for descuento in descuentos %}
              <tr>
                <td>{{ descuento.descripcion }}</td>
                <td>
                  {% if descuento.monto %}
                    ${{ descuento.monto }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if descuento.porcentaje %}
                    {{ descuento.porcentaje }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if descuento.activo %}
                    <span class="badge bg-success">Sí</span>
                  {% else %}
                    <span class="badge bg-danger">No</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if descuento.fijo %}
                    <span class="badge bg-success">Sí</span>
                  {% else %}
                    <span class="badge bg-danger">No</span>
                  {% endif %}
                </td>
                <td>
                  <div class="d-flex justify-content-center gap-2">
                    <button class="btn btn-sm btn-outline-secondary" 
                            data-bs-toggle="modal" data-bs-target="#modalDescuento"
                            data-id="{{ descuento.id }}"
                            data-descripcion="{{ descuento.descripcion }}"
                            data-monto="{{ descuento.monto }}"
                            data-porcentaje="{{ descuento.porcentaje }}"
                            data-fijo="{{ descuento.fijo }}"
                            onclick="editarDescuento(this)"
                            data-bs-toggle="tooltip" title="Editar">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" 
                            data-bs-toggle="modal" 
                            data-bs-target="#modalVerDescuento{{ descuento.id }}"
                            data-bs-toggle="tooltip" title="Ver">
                      <i class="bi bi-eye"></i>
                    </button>
                    {% if descuento.activo %}
                      <button class="btn btn-sm btn-outline-danger" 
                              data-bs-toggle="modal" 
                              data-bs-target="#modalDesactivarDescuento"
                              data-id="{{ descuento.id }}"
                              data-bs-toggle="tooltip" title="Desactivar">
                        <i class="bi bi-trash3"></i>
                      </button>
                    {% else %}
                      <button class="btn btn-sm btn-outline-success" 
                              data-bs-toggle="modal" 
                              data-bs-target="#modalActivarDescuento"
                              data-id="{{ descuento.id }}">
                        <i class="bi bi-arrow-counterclockwise"></i>
                      </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="text-center text-muted">
                  No hay descuentos registrados.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <nav aria-label="Paginación">
            <ul class="pagination justify-content-center mt-4">
              {% if descuentos.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ descuentos.previous_page_number }}">&laquo;</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
              {% endif %}

              {% for num in descuentos.paginator.page_range %}
                <li class="page-item {% if descuentos.number == num %}active{% endif %}">
                  <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
              {% endfor %}

              {% if descuentos.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ descuentos.next_page_number }}">&raquo;</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
              {% endif %}
            </ul>
          </nav>
          
        </div>
      </div>
    </div>

    <!-- Modal para Crear/Actualizar -->
    <div class="modal fade" id="modalDescuento" tabindex="-1" aria-labelledby="modalDescuentoLabel" aria-hidden="true">
      <div class="modal-dialog" style="margin-top: 6rem;">
        <div class="modal-content">
          <form method="post" action="{% url 'crear_descuento' %}" id="formDescuento">
            {% csrf_token %}
            <div class="modal-header" style="background-color: #3c8dbc;">
              <h5 class="modal-title text-white" id="modalDescuentoLabel">Crear/Editar Desceunto</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <input type="hidden" name="id_descuento" id="id_descuento">
            <div class="modal-body">
              <div class="mb-3">
                <label for="id_descripcion" class="form-label">Descripción</label>
                {{ form.descripcion }}
              </div>
              <div class="mb-3">
                <label for="id_monto" class="form-label">Monto</label>
                <div class="input-group input-group-sm" style="max-width: 250px;">
                  <span class="input-group-text">$</span>
                  {{ form.monto }}
                </div>
              </div>
              <div class="mb-3">
                <label for="id_porcentaje" class="form-label">Porcentaje</label>
                 <div class="input-group input-group-sm" style="max-width: 250px;">
                  {{ form.porcentaje }}
                  <span class="input-group-text">%</span>
                </div>
              </div>
              <div class="mb-3 form-check">
                {{ form.fijo }}
                <label for="id_fijo" class="form-check-label">¿Es fijo?</label>
              </div>

              <div class="modal-footer bg-light">
                <button type="submit" class="btn btn-success w-100 fw-bold">  
                  <i class="bi bi-save"></i> Guardar
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para Ver Detalles -->
    {% for descuento in descuentos %}  
    <div class="modal fade" id="modalVerDescuento{{ descuento.id }}" tabindex="-1" aria-labelledby="modalVerDescuento{{ descuento.id }}Label" aria-hidden="true">
      <div class="modal-dialog" style="margin-top: 6rem;">
        <div class="modal-content">
          <div class="modal-header" style="background-color: #3c8dbc;">
            <h5 class="modal-title text-white" id="modalVerDescuento{{ descuento.id }}Label">Detalles del descuento</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><strong>Descripcion:</strong> {{ descuento.descripcion }}</p>
            <p><strong>Monto:</strong> 
              {% if descuento.monto %}
                ${{ descuento.monto }}
              {% else %}
                -
              {% endif %}
            </p>
            <p><strong>Porcentaje:</strong> 
              {% if descuento.porcentaje %}
                {{ descuento.porcentaje }}%
              {% else %}
                -
              {% endif %}
            </p>
            <p><strong>Activo:</strong> 
              {% if descuento.activo %}
                Sí
              {% else %}
                No
              {% endif %}
            </p>
            <p><strong>Fijo:</strong> 
              {% if descuento.fijo %}
                Sí
              {% else %}
                No
              {% endif %}
            </p>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}


    <!-- Modal para Confirmar Desactivar -->
    <div class="modal fade" id="modalDesactivarDescuento" tabindex="-1" aria-labelledby="modalDesactivarDescuentoLabel" aria-hidden="true">
      <div class="modal-dialog" style="margin-top: 12rem;">
        <div class="modal-content">
          <div class="modal-header" style="background-color: #3c8dbc;">
            <h5 class="modal-title text-white" id="modalDesactivarDescuentoLabel">Confirmar Eliminación</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><span id="textoConfirmacionDesactivarDescuento"></span></p>
          </div>
          <div class="modal-footer">
            <form id="formEliminarDescuento" method="post">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Eliminar</button>
            </form>
            <form id="formDesactivarDescuento" method="post" action="">
              {% csrf_token %}
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" name="accion" value="desactivar" class="btn btn-warning">Desactivar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Confirmar Activación -->
    <div class="modal fade" id="modalActivarDescuento" tabindex="-1" aria-labelledby="modalActivarDescuentoLabel" aria-hidden="true">
      <div class="modal-dialog" style="margin-top: 12rem;">
        <div class="modal-content">
          <div class="modal-header" style="background-color: #198754;">
            <h5 class="modal-title text-white" id="modalActivarDescuentoLabel">Confirmar Activación</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><span id="textoConfirmacionActivarDescuento"></span></p>
          </div>
          <div class="modal-footer">
            <form id="formActivarDescuento" method="post">
              {% csrf_token %}
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-success">Activar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>

    document.addEventListener("DOMContentLoaded", function () {

      const modalDesactivar = document.getElementById('modalDesactivarDescuento');
      modalDesactivar.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const descuentoId = button.getAttribute('data-id');
        
        const formDesactivar = document.getElementById('formDesactivarDescuento');
        formDesactivar.action = `/descuentos/${descuentoId}/desactivar/`;

        const formEliminar = document.getElementById('formEliminarDescuento');
        formEliminar.action = `/descuentos/${descuentoId}/eliminar/`;

        const descripcion = button.closest('tr').querySelector('td').textContent.trim();
        document.getElementById('textoConfirmacionDesactivarDescuento').textContent = `¿Estás seguro de desactivar o eliminar el Descuento "${descripcion}"?`;
      });

      const modalActivar = document.getElementById('modalActivarDescuento');
      modalActivar.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const descuentoId = button.getAttribute('data-id');
        
        const form = document.getElementById('formActivarDescuento');
        form.action = `/descuentos/${descuentoId}/activar/`;

        const descripcion = button.closest('tr').querySelector('td').textContent.trim();
        document.getElementById('textoConfirmacionActivarDescuento').textContent = `¿Estás seguro de activar el Descuento "${descripcion}"?`;
      });


      const montoInput = document.getElementById("id_monto");
      const porcentajeInput = document.getElementById("id_porcentaje");

      montoInput.addEventListener("input", function () {
        if (montoInput.value) {
          porcentajeInput.value = "";
          porcentajeInput.setAttribute("disabled", "true");
        } else {
          porcentajeInput.removeAttribute("disabled");
        }
      });

      porcentajeInput.addEventListener("input", function () {
        if (porcentajeInput.value) {
          montoInput.value = "";
          montoInput.setAttribute("disabled", "true");
        } else {
          montoInput.removeAttribute("disabled");
        }
      });

    });


    function limpiarFormulario() {
      const form = document.getElementById('formDescuento');
      form.reset();
      document.getElementById('id_descuento').value = '';
      document.getElementById('modalDescuentoLabel').textContent = 'Crear Nuevo Descuento';
      document.querySelector('#formDescuento button[type="submit"]').textContent = 'Guardar';

      const montoInput = document.getElementById("id_monto");
      const porcentajeInput = document.getElementById("id_porcentaje");
      montoInput.removeAttribute("disabled");
      porcentajeInput.removeAttribute("disabled");
    }


    function editarDescuento(button) {
      const descuentoId = button.getAttribute('data-id');
      const descripcion = button.getAttribute('data-descripcion');
      const monto = parseFloat(button.getAttribute('data-monto'));
      const porcentaje = parseFloat(button.getAttribute('data-porcentaje'));
      const fijo = button.getAttribute('data-fijo') === 'True';
      
      document.getElementById('id_descuento').value = descuentoId || '';
      document.getElementById('id_descripcion').value = descripcion || '';
      document.getElementById('id_monto').value = isNaN(monto) ? '' : monto.toFixed(2);
      document.getElementById('id_porcentaje').value = isNaN(porcentaje) ? '' : porcentaje.toFixed(2);
      document.getElementById('id_fijo').checked = fijo;
      
      document.getElementById('modalDescuentoLabel').textContent = 'Editar Descuento';
      document.querySelector('#formDescuento button[type="submit"]').textContent = 'Actualizar';

      const montoInput = document.getElementById("id_monto");
      const porcentajeInput = document.getElementById("id_porcentaje");

      if (montoInput.value) {
        porcentajeInput.value = "";
        porcentajeInput.setAttribute("disabled", "true");
      } else {
        porcentajeInput.removeAttribute("disabled");
      }

      if (porcentajeInput.value) {
        montoInput.value = "";
        montoInput.setAttribute("disabled", "true");
      } else {
        montoInput.removeAttribute("disabled");
      }
    }


    const modalCrearEditar = document.getElementById('modalDescuento');

    modalCrearEditar.addEventListener('show.bs.modal', function (event) {
      const triggerButton = event.relatedTarget;

      if (!triggerButton.getAttribute('data-id')) {
        limpiarFormulario();
      }

      const inputs = modalCrearEditar.querySelectorAll('input, select, textarea');
      inputs.forEach(i => i.style.display = 'block');
    });

  </script>
  {% endblock %}

</body>
</html>
